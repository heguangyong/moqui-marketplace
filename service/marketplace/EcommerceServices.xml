<?xml version="1.0" encoding="UTF-8"?>
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-3.xsd"
          default-service-name="marketplace.EcommerceServices">

    <service verb="create" noun="Product" authenticate="true">
        <description>创建电商商品</description>
        <in-parameters>
            <parameter name="productName" required="true"/>
            <parameter name="productCategoryId"/>
            <parameter name="price" type="BigDecimal" default-value="0.00"/>
            <parameter name="stockQuantity" type="Long" default-value="0"/>
            <parameter name="status" default-value="ACTIVE"/>
            <parameter name="description"/>
            <parameter name="imageUrl"/>
        </in-parameters>
        <out-parameters>
            <parameter name="ecommerceProductId"/>
        </out-parameters>
        <actions>
            <set field="ecommerceProductId" from="ec.entity.sequencedIdPrimary"/>
            <set field="createdDate" from="ec.user.nowTimestamp"/>
            <set field="createdByUserId" from="ec.user.userId"/>
            <set field="lastUpdatedDate" from="createdDate"/>
            <service-call name="create#marketplace.ecommerce.EcommerceProduct"
                          in-map="context + [ecommerceProductId:ecommerceProductId]"/>
        </actions>
    </service>

    <service verb="update" noun="Product" authenticate="true">
        <in-parameters>
            <parameter name="ecommerceProductId" required="true"/>
            <parameter name="productName"/>
            <parameter name="productCategoryId"/>
            <parameter name="price" type="BigDecimal"/>
            <parameter name="stockQuantity" type="Long"/>
            <parameter name="status"/>
            <parameter name="description"/>
            <parameter name="imageUrl"/>
        </in-parameters>
        <actions>
            <set field="lastUpdatedDate" from="ec.user.nowTimestamp"/>
            <service-call name="update#marketplace.ecommerce.EcommerceProduct" in-map="context"/>
        </actions>
    </service>

    <service verb="get" noun="ProductList" authenticate="true">
        <in-parameters>
            <parameter name="productCategoryId"/>
            <parameter name="status"/>
            <parameter name="pageIndex" type="Integer" default="0"/>
            <parameter name="pageSize" type="Integer" default="20"/>
        </in-parameters>
        <out-parameters>
            <parameter name="products" type="List"/>
        </out-parameters>
        <actions>
            <script><![CDATA[
                def find = ec.entity.find("marketplace.ecommerce.EcommerceProduct")
                if (productCategoryId) find.condition("productCategoryId", productCategoryId)
                if (status) find.condition("status", status)
                int size = (pageSize ?: 20) as int
                int index = (pageIndex ?: 0) as int
                find.offset(index * size).limit(size)
                find.orderBy("-lastUpdatedDate")
                def entityList = find.list()
                products = entityList ? entityList.collect { it.getMap(false) } : []
            ]]></script>
        </actions>
    </service>

    <service verb="search" noun="Products" authenticate="true">
        <description>按关键词和价格区间搜索商品</description>
        <in-parameters>
            <parameter name="keyword"/>
            <parameter name="categoryId"/>
            <parameter name="minPrice" type="BigDecimal"/>
            <parameter name="maxPrice" type="BigDecimal"/>
            <parameter name="limit" type="Integer" default="20"/>
        </in-parameters>
        <out-parameters>
            <parameter name="products" type="List"/>
        </out-parameters>
        <actions><script><![CDATA[
            def find = ec.entity.find("marketplace.ecommerce.EcommerceProduct")
            find.limit((limit ?: 20) as int)
            find.orderBy("-lastUpdatedDate")
            if (categoryId) find.condition("productCategoryId", categoryId)
            if (keyword) {
                def keywordLike = "%${keyword.toString().toLowerCase()}%"
                find.where((ec.entity.conditionFactory.makeCondition("productName", org.moqui.entity.EntityCondition.Like, keywordLike))
                        .or(ec.entity.conditionFactory.makeCondition("description", org.moqui.entity.EntityCondition.Like, keywordLike)))
            }
            if (minPrice) find.condition("price", org.moqui.entity.EntityCondition.GreaterThanOrEqualTo, minPrice)
            if (maxPrice) find.condition("price", org.moqui.entity.EntityCondition.LessThanOrEqualTo, maxPrice)
            def entityList = find.list()
            products = entityList ? entityList.collect { it.getMap(false) } : []
        ]]></script></actions>
    </service>

    <service verb="create" noun="Order" authenticate="true">
        <description>创建订单并写入明细</description>
        <in-parameters>
            <parameter name="ecommerceCustomerId" required="true"/>
            <parameter name="cartId"/>
            <parameter name="orderItems" type="List" required="true"/>
            <parameter name="shippingAddress"/>
        </in-parameters>
        <out-parameters>
            <parameter name="ecommerceOrderId"/>
            <parameter name="orderTotal" type="BigDecimal"/>
        </out-parameters>
        <actions><script><![CDATA[
            import java.math.BigDecimal
            if (!orderItems || orderItems.isEmpty()) {
                ec.message.addError("订单需要至少一个商品")
                return
            }
            ecommerceOrderId = ec.entity.sequencedIdPrimary
            BigDecimal total = BigDecimal.ZERO
            List<Map> seqItems = []
            List<Map> inventoryAdjustments = []
            orderItems.eachWithIndex { Map item, int idx ->
                String productId = item.ecommerceProductId ?: item.productId
                if (!productId) {
                    ec.message.addError("订单第 ${idx + 1} 项缺少商品ID")
                    return
                }
                def productValue = ec.entity.find("marketplace.ecommerce.EcommerceProduct")
                        .condition("ecommerceProductId", productId)
                        .disableAuthz()
                        .one()
                if (!productValue) {
                    ec.message.addError("商品 ${productId} 不存在")
                    return
                }
                BigDecimal qty = item.quantity instanceof BigDecimal ? (BigDecimal) item.quantity :
                        new BigDecimal(item.quantity ?: "1")
                if (qty.compareTo(BigDecimal.ZERO) <= 0) {
                    ec.message.addError("商品 ${productValue.productName ?: productId} 数量需大于 0")
                    return
                }
                Long available = productValue.stockQuantity instanceof Number ?
                        ((Number) productValue.stockQuantity).longValue() :
                        (productValue.stockQuantity?.toString()?.toLong() ?: 0L)
                if (available < qty.longValue()) {
                    ec.message.addError("商品 ${productValue.productName ?: productId} 库存不足（剩余 ${available}）")
                    return
                }
                BigDecimal price
                if (item.unitPrice != null) {
                    price = item.unitPrice instanceof BigDecimal ? (BigDecimal) item.unitPrice :
                            new BigDecimal(item.unitPrice.toString())
                } else if (productValue.price instanceof BigDecimal) {
                    price = (BigDecimal) productValue.price
                } else if (productValue.price != null) {
                    price = new BigDecimal(productValue.price.toString())
                } else {
                    price = BigDecimal.ZERO
                }
                BigDecimal lineTotal = qty.multiply(price)
                total = total.add(lineTotal)
                seqItems << [
                        orderItemSeqId    : String.format("%05d", idx + 1),
                        ecommerceOrderId  : ecommerceOrderId,
                        ecommerceProductId: productId,
                        quantity          : qty.intValue(),
                        unitPrice         : price,
                        itemTotal         : lineTotal
                ]
                inventoryAdjustments << [productId: productId, qty: qty.longValue()]
            }
            if (ec.message.hasError()) return

            Timestamp nowTs = ec.user.nowTimestamp
            ec.service.sync().name("create#marketplace.ecommerce.EcommerceOrder").parameters([
                    ecommerceOrderId   : ecommerceOrderId,
                    ecommerceCustomerId: ecommerceCustomerId,
                    cartId             : cartId,
                    orderStatus        : "CREATED",
                    orderTotal         : total,
                    shippingAddress    : shippingAddress,
                    createdDate        : nowTs,
                    createdByUserId    : ec.user.userId,
                    lastUpdatedDate    : nowTs
            ]).call()
            seqItems.each { Map oi ->
                ec.service.sync().name("create#marketplace.ecommerce.EcommerceOrderItem").parameters(
                        oi + [createdDate: nowTs, createdByUserId: ec.user.userId, lastUpdatedDate: nowTs]).call()
            }
            inventoryAdjustments.each { Map adj ->
                ec.service.sync().name("marketplace.EcommerceServices.update#ProductInventory").parameters([
                        ecommerceProductId: adj.productId,
                        quantityAdjustment: -adj.qty
                ]).call()
            }
            if (ec.message.hasError()) return
            orderTotal = total
        ]]></script></actions>
    </service>

    <service verb="get" noun="OrderStatus" authenticate="true">
        <in-parameters>
            <parameter name="ecommerceOrderId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="orderStatus"/>
            <parameter name="paymentStatus"/>
            <parameter name="order"/>
        </out-parameters>
        <actions>
            <set field="order" from="ec.entity.find(\"marketplace.ecommerce.EcommerceOrder\").condition(\"ecommerceOrderId\", ecommerceOrderId).one()"/>
            <if condition="!order">
                <set field="orderStatus" value="NOT_FOUND"/>
                <return/>
            </if>
            <set field="orderStatus" from="order.orderStatus"/>
            <set field="paymentStatus" from="order.paymentStatus"/>
        </actions>
    </service>

    <service verb="update" noun="OrderStatus" authenticate="true">
        <description>更新订单状态及支付状态</description>
        <in-parameters>
            <parameter name="ecommerceOrderId" required="true"/>
            <parameter name="orderStatus"/>
            <parameter name="paymentStatus"/>
        </in-parameters>
        <actions><script><![CDATA[
            def orderValue = ec.entity.find("marketplace.ecommerce.EcommerceOrder")
                    .condition("ecommerceOrderId", ecommerceOrderId)
                    .forUpdate(true)
                    .one()
            if (!orderValue) {
                ec.message.addError("订单不存在")
                return
            }
            if (orderStatus) orderValue.set("orderStatus", orderStatus)
            if (paymentStatus) orderValue.set("paymentStatus", paymentStatus)
            orderValue.set("lastUpdatedDate", ec.user.nowTimestamp)
            orderValue.store()
        ]]></script></actions>
    </service>

    <service verb="update" noun="ProductInventory" authenticate="true">
        <description>更新商品库存数量</description>
        <in-parameters>
            <parameter name="ecommerceProductId" required="true"/>
            <parameter name="stockQuantity" type="Long"/>
            <parameter name="quantityAdjustment" type="Long"/>
        </in-parameters>
        <actions><script><![CDATA[
            def value = ec.entity.find("marketplace.ecommerce.EcommerceProduct")
                    .condition("ecommerceProductId", ecommerceProductId)
                    .forUpdate(true)
                    .one()
            if (!value) {
                ec.message.addError("商品不存在")
                return
            }
            if (stockQuantity != null) {
                Long target = stockQuantity instanceof Number ? ((Number) stockQuantity).longValue() :
                        stockQuantity.toString().toLong()
                if (target < 0L) {
                    ec.message.addError("库存数量不能为负数")
                    return
                }
                value.set("stockQuantity", target)
            } else if (quantityAdjustment != null) {
                Long current = value.getLong("stockQuantity") ?: 0L
                Long adjustment = quantityAdjustment instanceof Number ? ((Number) quantityAdjustment).longValue() :
                        quantityAdjustment.toString().toLong()
                Long newQty = current + adjustment
                if (newQty < 0L) {
                    ec.message.addError("商品 ${value.productName ?: ecommerceProductId} 库存不足（当前 ${current}）")
                    return
                }
                value.set("stockQuantity", newQty)
            }
            value.set("lastUpdatedDate", ec.user.nowTimestamp)
            value.store()
        ]]></script></actions>
    </service>

    <service verb="get" noun="InventoryStatus" authenticate="true">
        <description>获取单个商品库存信息</description>
        <in-parameters>
            <parameter name="ecommerceProductId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="inventoryInfo" type="Map"/>
        </out-parameters>
        <actions>
            <set field="inventoryInfo" from="ec.entity.find(\"marketplace.ecommerce.EcommerceProduct\").condition(\"ecommerceProductId\", ecommerceProductId).one()?.getMap()"/>
            <if condition="!inventoryInfo">
                <set field="inventoryInfo" value="[:]"/>
                <set field="inventoryInfo.message" value="商品不存在"/>
            </if>
        </actions>
    </service>

    <service verb="get" noun="ProductRecommendations" authenticate="true">
        <description>根据评价与销量生成智能推荐列表</description>
        <in-parameters>
            <parameter name="ecommerceCustomerId"/>
            <parameter name="intentType"/>
            <parameter name="preferredCategoryId"/>
            <parameter name="limit" type="Integer" default="5"/>
        </in-parameters>
        <out-parameters>
            <parameter name="recommendations" type="List"/>
        </out-parameters>
        <actions><script><![CDATA[
            import java.math.BigDecimal
            import java.math.RoundingMode

            int maxResults = Math.max(1, Math.min((limit ?: 5) as int, 20))
            def productFind = ec.entity.find("marketplace.ecommerce.EcommerceProduct")
                    .condition("status", "ACTIVE")
            if (preferredCategoryId) productFind.condition("productCategoryId", preferredCategoryId)
            def productList = productFind.list()
            if (!productList || productList.isEmpty()) {
                recommendations = []
                return
            }

            Map<String, Map> ratingAgg = [:]
            def reviewList = ec.entity.find("marketplace.ecommerce.EcommerceProductReview")
                    .condition("status", "ACTIVE")
                    .list()
            reviewList?.each { reviewVal ->
                String pid = reviewVal.ecommerceProductId
                if (!pid) return
                BigDecimal rating = reviewVal.rating instanceof BigDecimal ?
                        (BigDecimal) reviewVal.rating :
                        (reviewVal.rating ? new BigDecimal(reviewVal.rating.toString()) : BigDecimal.ZERO)
                Map agg = ratingAgg.get(pid) ?: [total: BigDecimal.ZERO, count: 0]
                agg.total = agg.total.add(rating ?: BigDecimal.ZERO)
                agg.count = agg.count + (rating ? 1 : 0)
                ratingAgg[pid] = agg
            }

            Map<String, Long> orderAgg = [:]
            def orderItems = ec.entity.find("marketplace.ecommerce.EcommerceOrderItem").list()
            orderItems?.each { itemVal ->
                String pid = itemVal.ecommerceProductId
                if (!pid) return
                Long qty = itemVal.quantity instanceof Number ?
                        ((Number) itemVal.quantity).longValue() :
                        (itemVal.quantity?.toString()?.toLong() ?: 0L)
                orderAgg[pid] = (orderAgg[pid] ?: 0L) + (qty ?: 0L)
            }

            long maxOrderQty = orderAgg.values()?.max() ?: 0L
            BigDecimal ratingWeight
            BigDecimal salesWeight
            String normalizedIntent = intentType?.toUpperCase()
            switch (normalizedIntent) {
                case "B2B_PURCHASE":
                    ratingWeight = new BigDecimal("0.4")
                    salesWeight = new BigDecimal("0.6")
                    break
                case "PROJECT_EXPANSION":
                    ratingWeight = new BigDecimal("0.6")
                    salesWeight = new BigDecimal("0.4")
                    break
                case "SOCIAL_RETAIL":
                    ratingWeight = new BigDecimal("0.7")
                    salesWeight = new BigDecimal("0.3")
                    break
                default:
                    ratingWeight = new BigDecimal("0.55")
                    salesWeight = new BigDecimal("0.45")
                    break
            }

            List<Map> computed = []
            productList.each { prodVal ->
                String pid = prodVal.ecommerceProductId
                Map ratingStat = ratingAgg[pid] ?: [total: BigDecimal.ZERO, count: 0]
                BigDecimal avgRating = BigDecimal.ZERO
                if (ratingStat.count) {
                    avgRating = ratingStat.total.divide(new BigDecimal(ratingStat.count), 4, RoundingMode.HALF_UP)
                }
                BigDecimal ratingScore = avgRating.compareTo(BigDecimal.ZERO) > 0 ?
                        avgRating.divide(new BigDecimal("5"), 4, RoundingMode.HALF_UP) : BigDecimal.ZERO
                Long orderQty = orderAgg[pid] ?: 0L
                BigDecimal orderScore = (maxOrderQty > 0 && orderQty > 0) ?
                        new BigDecimal(orderQty).divide(new BigDecimal(maxOrderQty), 4, RoundingMode.HALF_UP) :
                        BigDecimal.ZERO
                BigDecimal compositeScore = ratingScore.multiply(ratingWeight)
                        .add(orderScore.multiply(salesWeight))
                        .setScale(4, RoundingMode.HALF_UP)

                String source = "综合推荐"
                if (orderScore.compareTo(ratingScore) > 0 && orderQty > 0) {
                    source = normalizedIntent == "B2B_PURCHASE" ? "B端热销" : "订单热度"
                } else if (ratingStat.count) {
                    source = normalizedIntent == "PROJECT_EXPANSION" ? "项目口碑" : "客户评价"
                }

                computed << [
                        ecommerceProductId   : pid,
                        productName          : prodVal.productName,
                        productCategoryId    : prodVal.productCategoryId,
                        price                : prodVal.price,
                        stockQuantity        : prodVal.stockQuantity,
                        avgRating            : avgRating,
                        reviewCount          : ratingStat.count,
                        orderCount           : orderQty,
                        recommendationScore  : compositeScore,
                        recommendationSource : source
                ]
            }

            recommendations = computed.sort { Map a, Map b ->
                b.recommendationScore <=> a.recommendationScore
            }.take(Math.min(maxResults, computed.size()))
        ]]></script></actions>
    </service>

    <service verb="get" noun="OrderList" authenticate="true">
        <description>查询订单列表</description>
        <in-parameters>
            <parameter name="ecommerceCustomerId"/>
            <parameter name="orderStatus"/>
            <parameter name="limit" type="Integer" default="20"/>
        </in-parameters>
        <out-parameters>
            <parameter name="orders" type="List"/>
        </out-parameters>
        <actions><script><![CDATA[
            def find = ec.entity.find("marketplace.ecommerce.EcommerceOrder")
                    .orderBy("-createdDate")
                    .limit(Math.max(1, Math.min((limit ?: 20) as int, 50)))
            if (ecommerceCustomerId) find.condition("ecommerceCustomerId", ecommerceCustomerId)
            if (orderStatus) find.condition("orderStatus", orderStatus.toString().toUpperCase())
            def list = find.list()
            orders = list ? list.collect { it.getMap(false) } : []
        ]]></script></actions>
    </service>

</services>
