<?xml version="1.0" encoding="UTF-8"?>
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-3.xsd"
          package-name="marketplace.ai">

    <!-- ==================== Marketplace AIÊúçÂä°ËøÅÁßªÂ±Ç ==================== -->

    <!-- Áªü‰∏ÄmarketplaceÊ∂àÊÅØÂ§ÑÁêÜÊúçÂä° - Êõø‰ª£MarketplaceMcpService.processMarketplaceMessage -->
    <service verb="process" noun="MarketplaceMessage" authenticate="false" allow-remote="true">
        <description>‰ΩøÁî®Áªü‰∏ÄMCP AIÊúçÂä°ÁöÑmarketplaceÊ∂àÊÅØÂ§ÑÁêÜ</description>
        <in-parameters>
            <parameter name="sessionId" required="true"/>
            <parameter name="message" required="true"/>
            <parameter name="merchantId" required="true"/>
            <parameter name="messageType" default-value="text"/>
            <parameter name="attachmentInfo" type="Map"/>
        </in-parameters>
        <out-parameters>
            <parameter name="success" type="Boolean"/>
            <parameter name="aiResponse"/>
            <parameter name="intent"/>
            <parameter name="transcribedText"/>
            <parameter name="matches" type="List"/>
            <parameter name="listingId"/>
            <parameter name="error"/>
        </out-parameters>
        <actions>
            <script><![CDATA[
                try {
                    ec.logger.info("Processing marketplace message using unified MCP AI services")

                    // Â§ÑÁêÜÂ§öÊ®°ÊÄÅÊ∂àÊÅØ
                    if (messageType != "text") {
                        def result = processMultimodalMessage(messageType, attachmentInfo, sessionId, merchantId, message)
                        success = result.success
                        aiResponse = result.aiResponse
                        intent = result.intent
                        transcribedText = result.transcribedText
                        error = result.error
                        return
                    }

                    // 1. ‰ΩøÁî®Áªü‰∏ÄÊÑèÂõæÂàÜÁ±ªÊúçÂä°
                    def intentResult = ec.service.sync().name("mcp.ai.classify#Intent").parameters([
                        userInput: message,
                        module: "marketplace",
                        context: buildMarketplaceContext(sessionId, merchantId)
                    ]).call()

                    if (!intentResult.success) {
                        throw new Exception("ÊÑèÂõæÂàÜÁ±ªÂ§±Ë¥•: " + intentResult.error)
                    }

                    intent = intentResult.intent
                    def extractedEntities = intentResult.extractedEntities

                    // 2. Ê†πÊçÆÊÑèÂõæÂ§ÑÁêÜ‰∏öÂä°ÈÄªËæë
                    def businessResult = processMarketplaceBusiness(intent, extractedEntities, message, sessionId, merchantId)

                    // 3. ‰ΩøÁî®Áªü‰∏ÄÊñáÊú¨ÁîüÊàêÊúçÂä°ÁîüÊàêÂìçÂ∫î
                    def textGenResult = ec.service.sync().name("mcp.ai.generate#Text").parameters([
                        prompt: buildMarketplacePrompt(message, intent, businessResult),
                        systemPrompt: "‰Ω†ÊòØ‰∏Ä‰∏™‰∏ì‰∏öÁöÑÂÜúË¥∏Â∏ÇÂú∫AIÂä©ÊâãÔºåÂ∏ÆÂä©ÂïÜÂÆ∂ËøõË°åÊô∫ËÉΩ‰æõÈúÄÊíÆÂêà„ÄÇ‰Ω†ÈúÄË¶Å‰øùÊåÅÁ§ºË≤å„ÄÅÁÆÄÊ¥ÅÔºåÂºïÂØºÁî®Êà∑Êèê‰æõÂøÖË¶Å‰ø°ÊÅØÔºåÂπ∂Âú®ÂèØËÉΩÁöÑÊÉÖÂÜµ‰∏ãË∞ÉÁî®Âπ≥Âè∞ÊúçÂä°ÂÆåÊàê‰æõÈúÄÂèëÂ∏É„ÄÅÂåπÈÖç„ÄÅÁªüËÆ°Á≠â‰ªªÂä°„ÄÇ",
                        context: buildMarketplaceContext(sessionId, merchantId),
                        module: "marketplace",
                        temperature: 0.2,
                        maxTokens: 1024
                    ]).call()

                    if (!textGenResult.success) {
                        throw new Exception("ÊñáÊú¨ÁîüÊàêÂ§±Ë¥•: " + textGenResult.error)
                    }

                    // 4. ‰øùÂ≠òÂØπËØùËÆ∞ÂΩï
                    saveMarketplaceDialog(sessionId, message, textGenResult.generatedText, intent, merchantId)

                    // 5. ËøîÂõûÁªìÊûú
                    success = true
                    aiResponse = textGenResult.generatedText
                    matches = businessResult.matches
                    listingId = businessResult.listingId

                    ec.logger.info("Marketplace message processed successfully: ${intent}")

                } catch (Exception e) {
                    ec.logger.error("Error processing marketplace message: ${e.message}", e)
                    success = false
                    error = e.message
                    aiResponse = "Êä±Ê≠âÔºåÁ≥ªÁªüÊöÇÊó∂Êó†Ê≥ïÂ§ÑÁêÜÊÇ®ÁöÑËØ∑Ê±ÇÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇ"
                }
            ]]></script>
        </actions>
    </service>

    <!-- Â§öÊ®°ÊÄÅÊ∂àÊÅØÂ§ÑÁêÜÊúçÂä° -->
    <service verb="processMultimodalMessage" noun="Internal" authenticate="false" type="inline">
        <in-parameters>
            <parameter name="messageType" required="true"/>
            <parameter name="attachmentInfo" type="Map" required="true"/>
            <parameter name="sessionId" required="true"/>
            <parameter name="merchantId" required="true"/>
            <parameter name="message" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="success" type="Boolean"/>
            <parameter name="aiResponse"/>
            <parameter name="intent"/>
            <parameter name="transcribedText"/>
            <parameter name="error"/>
        </out-parameters>
        <actions>
            <script><![CDATA[
                try {
                    switch (messageType) {
                        case "voice":
                        case "audio":
                            def voiceResult = processVoiceMessage(attachmentInfo, sessionId, merchantId)
                            success = voiceResult.success
                            aiResponse = voiceResult.aiResponse
                            intent = voiceResult.intent
                            transcribedText = voiceResult.transcribedText
                            error = voiceResult.error
                            break

                        case "photo":
                            def imageResult = processImageMessage(attachmentInfo, sessionId, merchantId, message)
                            success = imageResult.success
                            aiResponse = imageResult.aiResponse
                            intent = imageResult.intent
                            error = imageResult.error
                            break

                        default:
                            success = true
                            intent = "unsupported_media"
                            aiResponse = "Êî∂Âà∞ÊÇ®ÁöÑ${messageType}Ê∂àÊÅØÔºåÁõÆÂâçÁ≥ªÁªüÊ≠£Âú®Â≠¶‰π†Â§ÑÁêÜËøôÁßçÁ±ªÂûãÁöÑÂÜÖÂÆπ„ÄÇËØ∑ÊÇ®Áî®ÊñáÂ≠óÊèèËø∞ÊÇ®ÁöÑÈúÄÊ±Ç„ÄÇ"
                    }
                } catch (Exception e) {
                    success = false
                    error = e.message
                    aiResponse = "Êä±Ê≠âÔºåÊöÇÊó∂Êó†Ê≥ïÂ§ÑÁêÜÊÇ®ÂèëÈÄÅÁöÑÂÜÖÂÆπÔºåËØ∑Áî®ÊñáÂ≠óÊèèËø∞ÊÇ®ÁöÑÈúÄÊ±Ç„ÄÇ"
                }
            ]]></script>
        </actions>
    </service>

    <!-- ËØ≠Èü≥Ê∂àÊÅØÂ§ÑÁêÜÊúçÂä° -->
    <service verb="processVoiceMessage" noun="Internal" authenticate="false" type="inline">
        <in-parameters>
            <parameter name="attachmentInfo" type="Map" required="true"/>
            <parameter name="sessionId" required="true"/>
            <parameter name="merchantId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="success" type="Boolean"/>
            <parameter name="aiResponse"/>
            <parameter name="intent"/>
            <parameter name="transcribedText"/>
            <parameter name="error"/>
        </out-parameters>
        <actions>
            <script><![CDATA[
                try {
                    ec.logger.info("Processing voice message using unified MCP AI service")

                    def fileId = attachmentInfo?.fileId
                    if (!fileId) {
                        throw new Exception("Áº∫Â∞ëÈü≥È¢ëÊñá‰ª∂ID")
                    }

                    // 1. ‰∏ãËΩΩÈü≥È¢ëÊñá‰ª∂
                    def audioUrl = downloadTelegramAudioFile(fileId)
                    if (!audioUrl) {
                        throw new Exception("Êó†Ê≥ï‰∏ãËΩΩÈü≥È¢ëÊñá‰ª∂")
                    }

                    // 2. ‰ΩøÁî®Áªü‰∏ÄÈü≥È¢ëËΩ¨ÂΩïÊúçÂä°
                    def transcribeResult = ec.service.sync().name("mcp.ai.transcribe#Audio").parameters([
                        audioUrl: audioUrl,
                        module: "marketplace",
                        language: "auto"
                    ]).call()

                    if (!transcribeResult.success) {
                        throw new Exception("Èü≥È¢ëËΩ¨ÂΩïÂ§±Ë¥•: " + transcribeResult.error)
                    }

                    transcribedText = transcribeResult.transcribedText
                    def detectedLanguage = transcribeResult.detectedLanguage

                    // 3. Â¶ÇÊûúËΩ¨ÂΩïÊàêÂäüÔºåÂ§ÑÁêÜËΩ¨ÂΩïÊñáÊú¨
                    if (transcribedText && !transcribedText.trim().isEmpty()) {
                        // ‰ΩøÁî®ËΩ¨ÂΩïÊñáÊú¨ËøõË°åÊÑèÂõæÂàÜÊûêÂíåÂìçÂ∫îÁîüÊàê
                        def processResult = ec.service.sync().name("marketplace.ai.process#MarketplaceMessage").parameters([
                            sessionId: sessionId,
                            message: transcribedText,
                            merchantId: merchantId,
                            messageType: "text"
                        ]).call()

                        success = processResult.success
                        aiResponse = processResult.aiResponse
                        intent = processResult.intent
                        error = processResult.error

                        // Â¢ûÂº∫ËØ≠Èü≥ÂìçÂ∫îÊ†ºÂºè
                        if (success) {
                            aiResponse = buildVoiceResponse(transcribedText, detectedLanguage, aiResponse, intent)
                        }
                    } else {
                        // ËΩ¨ÂΩïÂ§±Ë¥•ÁöÑÂõûÂ§ç
                        success = true
                        intent = "voice_processing_failed"
                        aiResponse = "üéôÔ∏è Êî∂Âà∞ÊÇ®ÁöÑËØ≠Èü≥Ê∂àÊÅØÔºÅ\\n\\n" +
                                   "üîÑ ËØ≠Èü≥ËØÜÂà´ÈÅáÂà∞Âõ∞ÈöæÔºåËØ∑ÊÇ®Ôºö\\n" +
                                   "üìù **ÈáçÊñ∞Áî®ÊñáÂ≠óÊèèËø∞**\\n" +
                                   "‚Ä¢ ÊÇ®Ë¶ÅÂèëÂ∏É‰æõÂ∫î‰ø°ÊÅØÂêóÔºü\\n" +
                                   "‚Ä¢ ÊÇ®Ë¶ÅÈááË¥≠ÊüêÁßç‰∫ßÂìÅÂêóÔºü\\n" +
                                   "‚Ä¢ ÊÇ®ÊÉ≥Êü•ÁúãÂåπÈÖçÂª∫ËÆÆÂêóÔºü\\n\\n" +
                                   "üí° ÊèêÁ§∫ÔºöËØ¥ËØùÊ∏ÖÊô∞‰∏Ä‰∫õÔºåÊîØÊåÅ‰∏≠Ëã±ÊñáÊ∑∑ÂêàËØ≠Èü≥"
                    }

                } catch (Exception e) {
                    ec.logger.error("Error in voice message processing: ${e.message}", e)
                    success = false
                    error = e.message
                    aiResponse = "üéôÔ∏è ËØ≠Èü≥Ê∂àÊÅØÂ§ÑÁêÜÂá∫ÈîôÔºåËØ∑Áî®ÊñáÂ≠óÊèèËø∞ÊÇ®ÁöÑÈúÄÊ±Ç„ÄÇ"
                }
            ]]></script>
        </actions>
    </service>

    <!-- ÂõæÂÉèÊ∂àÊÅØÂ§ÑÁêÜÊúçÂä° -->
    <service verb="processImageMessage" noun="Internal" authenticate="false" type="inline">
        <in-parameters>
            <parameter name="attachmentInfo" type="Map" required="true"/>
            <parameter name="sessionId" required="true"/>
            <parameter name="merchantId" required="true"/>
            <parameter name="caption"/>
        </in-parameters>
        <out-parameters>
            <parameter name="success" type="Boolean"/>
            <parameter name="aiResponse"/>
            <parameter name="intent"/>
            <parameter name="analysis"/>
            <parameter name="productType"/>
            <parameter name="error"/>
        </out-parameters>
        <actions>
            <script><![CDATA[
                try {
                    ec.logger.info("Processing image message using unified MCP AI service")

                    def fileId = attachmentInfo?.fileId
                    if (!fileId) {
                        throw new Exception("Áº∫Â∞ëÂõæÂÉèÊñá‰ª∂ID")
                    }

                    // 1. ‰∏ãËΩΩÂõæÂÉèÊñá‰ª∂
                    def imageUrl = downloadTelegramImageFile(fileId)
                    if (!imageUrl) {
                        throw new Exception("Êó†Ê≥ï‰∏ãËΩΩÂõæÂÉèÊñá‰ª∂")
                    }

                    // 2. ‰ΩøÁî®Áªü‰∏ÄÂõæÂÉèÂàÜÊûêÊúçÂä°
                    def analyzeResult = ec.service.sync().name("mcp.ai.analyze#Image").parameters([
                        imageUrl: imageUrl,
                        module: "marketplace",
                        analysisType: "product",
                        language: "zh-CN",
                        customPrompt: "ËØ∑ÂàÜÊûêËøôÂº†ÂõæÁâáÔºåËØÜÂà´ÂÖ∂‰∏≠ÁöÑ‰∫ßÂìÅ„ÄÅÊùêÊñôÊàñÁâ©ÂìÅ„ÄÇÈáçÁÇπËØÜÂà´Â∑•‰∏öÊùêÊñô„ÄÅÊú∫Ê¢∞ËÆæÂ§á„ÄÅÂª∫Á≠ëÊùêÊñôÊàñÂïÜ‰∏ö‰∫ßÂìÅ„ÄÇ"
                    ]).call()

                    if (!analyzeResult.success) {
                        throw new Exception("ÂõæÂÉèÂàÜÊûêÂ§±Ë¥•: " + analyzeResult.error)
                    }

                    analysis = analyzeResult.analysis
                    def tags = analyzeResult.tags
                    def confidence = analyzeResult.confidence

                    // 3. ÊèêÂèñ‰∫ßÂìÅÁ±ªÂûã
                    productType = extractProductTypeFromAnalysis(analysis, tags)

                    // 4. ÁîüÊàêÊô∫ËÉΩÂìçÂ∫î
                    def responsePrompt = buildImageResponsePrompt(analysis, productType, caption, attachmentInfo)

                    def textGenResult = ec.service.sync().name("mcp.ai.generate#Text").parameters([
                        prompt: responsePrompt,
                        systemPrompt: "‰Ω†ÊòØmarketplaceÂõæÂÉèÂàÜÊûêAIÂä©ÊâãÔºåÂ∏ÆÂä©ÂïÜÂÆ∂ÂàÜÊûê‰∫ßÂìÅÂõæÁâáÂπ∂Êèê‰æõ‰∏öÂä°Âª∫ËÆÆ„ÄÇ",
                        module: "marketplace",
                        temperature: 0.3,
                        maxTokens: 800
                    ]).call()

                    if (textGenResult.success) {
                        aiResponse = textGenResult.generatedText
                    } else {
                        // ‰ΩøÁî®ÂàÜÊûêÁªìÊûúÁîüÊàêÂü∫Á°ÄÂìçÂ∫î
                        aiResponse = buildBasicImageResponse(analysis, productType, caption)
                    }

                    success = true
                    intent = "image_processing"

                    ec.logger.info("Image message processed successfully")

                } catch (Exception e) {
                    ec.logger.error("Error in image message processing: ${e.message}", e)
                    success = false
                    error = e.message
                    aiResponse = "üì∑ ÂõæÂÉèÂàÜÊûêÈÅáÂà∞ÈóÆÈ¢òÔºåËØ∑ÊÇ®Áî®ÊñáÂ≠óÊèèËø∞ÂõæÁâá‰∏≠ÁöÑ‰∫ßÂìÅ‰ø°ÊÅØ„ÄÇ"
                }
            ]]></script>
        </actions>
    </service>

    <!-- ==================== ËæÖÂä©ÊñπÊ≥ïÊúçÂä° ==================== -->

    <!-- ÊûÑÂª∫marketplace‰∏ä‰∏ãÊñá -->
    <service verb="buildMarketplaceContext" noun="Internal" authenticate="false" type="inline">
        <in-parameters>
            <parameter name="sessionId" required="true"/>
            <parameter name="merchantId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="context"/>
        </out-parameters>
        <actions>
            <script><![CDATA[
                // ÊûÑÂª∫marketplace‰∏ä‰∏ãÊñá‰ø°ÊÅØ
                StringBuilder contextBuilder = new StringBuilder()
                contextBuilder.append("ÂïÜÂÆ∂ID: ").append(merchantId).append("\\n")
                contextBuilder.append("‰ºöËØùID: ").append(sessionId).append("\\n")

                // Ëé∑ÂèñÊúÄËøëÁöÑÂØπËØùÂéÜÂè≤
                try {
                    def recentMessages = ec.entity.find("mcp.dialog.McpDialogMessage")
                        .condition("sessionId", sessionId)
                        .orderBy("-processedDate")
                        .limit(3)
                        .disableAuthz()
                        .list()

                    if (recentMessages) {
                        contextBuilder.append("ÊúÄËøëÂØπËØù:\\n")
                        recentMessages.each { msg ->
                            contextBuilder.append("Áî®Êà∑: ").append(msg.message ?: '').append("\\n")
                            contextBuilder.append("Âä©Êâã: ").append(msg.aiResponse ?: '').append("\\n")
                        }
                    }
                } catch (Exception e) {
                    ec.logger.warn("Failed to get recent messages: ${e.message}")
                }

                context = contextBuilder.toString()
            ]]></script>
        </actions>
    </service>

    <!-- ‰øùÂ≠òÂØπËØùËÆ∞ÂΩï -->
    <service verb="saveMarketplaceDialog" noun="Internal" authenticate="false" type="inline">
        <in-parameters>
            <parameter name="sessionId" required="true"/>
            <parameter name="message" required="true"/>
            <parameter name="aiResponse" required="true"/>
            <parameter name="intent" required="true"/>
            <parameter name="merchantId" required="true"/>
        </in-parameters>
        <actions>
            <script><![CDATA[
                try {
                    // ‰øùÂ≠òÂà∞MCPÂØπËØùÂéÜÂè≤Ë°®
                    ec.service.sync().name("mcp.dialog.create#DialogMessage").parameters([
                        sessionId: sessionId,
                        message: message,
                        aiResponse: aiResponse,
                        intent: intent,
                        module: "marketplace",
                        userId: merchantId
                    ]).call()
                } catch (Exception e) {
                    ec.logger.warn("Failed to save marketplace dialog: ${e.message}")
                }
            ]]></script>
        </actions>
    </service>

</services>