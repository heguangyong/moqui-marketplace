<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-3.xsd"
        default-menu-title="智能匹配" require-authentication="false">

    <parameter name="merchantId"/>
    <parameter name="listingId"/>
    <parameter name="minScore"/>
    <parameter name="maxResults"/>
    <parameter name="matchMode" default="traditional"/>
    <parameter name="projectDescription"/>

    <actions>
        <if condition="!merchantId">
            <set field="merchantId" value="__ALL__"/>
        </if>
        <script><![CDATA[
            import java.math.BigDecimal
            import java.math.RoundingMode

            def isAllMerchant = !merchantId || "__ALL__".equalsIgnoreCase(merchantId) || "ALL".equalsIgnoreCase(merchantId)
            displayMerchantName = isAllMerchant ? "全部商户" : merchantId

            candidateListings = []
            matchResults = []
            matchError = null
            projectCategory = null
            projectConfidencePercent = null
            projectClassificationMessage = null

            def resolvedMatchMode = (matchMode ?: "traditional").toLowerCase()
            matchMode = resolvedMatchMode in ["project", "traditional"] ? resolvedMatchMode : "traditional"

            if (matchMode == "project" && projectDescription) {
                try {
                    Map classifyResult = ec.service.sync().name("mcp.routing.classify#UserIntent").parameters([
                        userMessage: projectDescription,
                        messageType: "text"
                    ]).call()
                    projectCategory = classifyResult.businessCategory ?: "SUPPLY_DEMAND_MATCHING"
                    BigDecimal confidence = classifyResult.confidence instanceof BigDecimal ?
                            (BigDecimal) classifyResult.confidence :
                            new BigDecimal(classifyResult.confidence?.toString() ?: "0")
                    confidence = confidence.max(BigDecimal.ZERO).min(BigDecimal.ONE)
                    projectConfidencePercent = confidence.multiply(new BigDecimal("100")).setScale(0, RoundingMode.HALF_UP)
                    projectClassificationMessage = "识别为：${projectCategory}，置信度 ${projectConfidencePercent}%"
                } catch (Exception e) {
                    ec.logger.warn("项目匹配分类失败: ${e.message}")
                    projectClassificationMessage = "智能识别暂不可用，请改用传统模式。"
                }
            }

            def listingTypeFilter = matchMode == "project" && projectCategory == "HIVEMIND_PROJECT" ? "DEMAND" : null

            def listingFind = ec.entity.find("marketplace.listing.Listing")
                .orderBy("-createdDate")
                .limit(30)
            if (!isAllMerchant) listingFind.condition("publisherId", merchantId)
            if (listingTypeFilter) listingFind.condition("listingType", listingTypeFilter)
            listingFind.disableAuthz()
            listingFind.list().each { listing ->
                candidateListings.add([
                    listingId   : listing.listingId,
                    title       : listing.title ?: listing.listingId,
                    listingType : listing.listingType ?: "SUPPLY",
                    status      : listing.status ?: "ACTIVE",
                    createdDate : listing.createdDate
                ])
            }

            selectedListingId = listingId
            if (!selectedListingId && candidateListings) selectedListingId = candidateListings[0].listingId

            selectedMinScore = (minScore ?: "0.6").toString()
            selectedMaxResults = (maxResults ?: "20").toString()

            Closure<Map> getListingInfo = { String id ->
                if (!id) return [title: id]
                def infoFind = ec.entity.find("marketplace.listing.Listing")
                    .condition("listingId", id)
                infoFind.disableAuthz()
                def value = infoFind.one()
                return [
                    title      : value?.title ?: id,
                    listingType: value?.listingType ?: "",
                    publisherId: value?.publisherId
                ]
            }

            if (selectedListingId) {
                try {
                    Map resp = ec.service.sync().name("marketplace.MarketplaceServices.find#Matches")
                        .parameters([
                            listingId : selectedListingId,
                            minScore  : new BigDecimal(selectedMinScore),
                            maxResults: Integer.valueOf(selectedMaxResults)
                        ]).call()
                    List<Map<String,Object>> serviceMatches = resp.matches ?: []
                    serviceMatches.each { item ->
                        Map supplyInfo = getListingInfo(item.supplyListingId)
                        Map demandInfo = getListingInfo(item.demandListingId)
                        BigDecimal score = item.matchScore ?: BigDecimal.ZERO
                        matchResults.add([
                            matchId           : item.matchId ?: "",
                            supplyListingId   : item.supplyListingId,
                            supplyTitle       : supplyInfo.title,
                            demandListingId   : item.demandListingId,
                            demandTitle       : demandInfo.title,
                            matchScorePercent : score.multiply(new BigDecimal("100")).setScale(1, RoundingMode.HALF_UP),
                            status            : item.status ?: "SUGGESTED",
                            suggestedDate     : item.suggestedDate ?: item.createdDate
                        ])
                    }
                } catch (Exception e) {
                    matchError = e.message
                    ec.logger.warn("匹配服务失败: ${e.message}")
                }
            }
        ]]></script>
    </actions>

    <widgets>
        <container>
            <label text="智能匹配控制台" type="h2"/>
            <label text="当前视角：${displayMerchantName}" type="p"/>
        </container>

        <container style="q-card q-mb-md">
            <container style="q-card__section">
                <form-single name="ModeForm" method="get">
                    <container-row>
                        <row-col lg="4" md="6" sm="12">
                            <field name="matchMode">
                                <default-field title="匹配模式">
                                    <drop-down>
                                        <option key="traditional" text="传统撮合"/>
                                        <option key="project" text="项目匹配"/>
                                    </drop-down>
                                </default-field>
                            </field>
                        </row-col>
                        <row-col lg="4" md="6" sm="12">
                            <field name="projectDescription" condition="${matchMode == 'project'}">
                                <default-field title="项目需求描述">
                                    <text-area rows="2" cols="40" default-value="${projectDescription ?: ''}"/>
                                </default-field>
                            </field>
                        </row-col>
                        <row-col lg="4" md="12" sm="12" style="align-items:flex-end; display:flex;">
                            <field name="modeSubmit">
                                <default-field title="">
                                    <submit text="应用模式"/>
                                </default-field>
                            </field>
                        </row-col>
                    </container-row>
                </form-single>
                <if condition="${projectClassificationMessage}">
                    <label text="${projectClassificationMessage}" type="p" style="color:#1976d2;"/>
                </if>
            </container>
        </container>

        <form-single name="MatchingFilterForm" method="get">
            <field name="merchantId">
                <default-field title="商户ID">
                    <text-line size="25" default-value="${(merchantId == '__ALL__' || merchantId == 'ALL') ? '' : merchantId}"/>
                </default-field>
            </field>
            <field name="listingId">
                <default-field title="选择供需信息">
                    <drop-down>
                        <option key="" text="自动选择最新记录"/>
                        <list-options list="candidateListings" key-field="listingId" text-field="title"/>
                    </drop-down>
                </default-field>
            </field>
            <field name="minScore">
                <default-field title="最低匹配度(0~1)">
                    <text-line size="6" default-value="${minScore ?: '0.6'}"/>
                </default-field>
            </field>
            <field name="maxResults">
                <default-field title="最大结果数">
                    <text-line size="6" default-value="${maxResults ?: '20'}"/>
                </default-field>
            </field>
            <field name="submit">
                <default-field title="">
                    <submit text="重新匹配"/>
                </default-field>
            </field>
        </form-single>

        <if condition="matchError">
            <label text="匹配失败：${matchError}" type="p" style="text-danger"/>
        </if>

        <container>
            <label text="匹配结果" type="h4"/>
            <container style="table table-striped">
                <container style="thead">
                    <container style="tr">
                        <container style="th"><label text="匹配ID"/></container>
                        <container style="th"><label text="供应信息"/></container>
                        <container style="th"><label text="需求信息"/></container>
                        <container style="th"><label text="匹配度(%)"/></container>
                        <container style="th"><label text="状态"/></container>
                        <container style="th"><label text="时间"/></container>
                    </container>
                </container>
                <container style="tbody">
                    <section-iterate name="MatchResultIterate" list="matchResults" entry="match">
                        <widgets>
                            <container style="tr">
                                <container style="td"><label text="${match.matchId ?: '—'}"/></container>
                                <container style="td"><label text="${match.supplyTitle ?: '—'}"/></container>
                                <container style="td"><label text="${match.demandTitle ?: '—'}"/></container>
                                <container style="td"><label text="${match.matchScorePercent ?: '—'}"/></container>
                                <container style="td"><label text="${match.status ?: '—'}"/></container>
                                <container style="td"><label text="${match.suggestedDate ? ec.l10n.format(match.suggestedDate, 'yyyy-MM-dd HH:mm') : '—'}"/></container>
                            </container>
                        </widgets>
                    </section-iterate>
                </container>
            </container>
        </container>
    </widgets>
</screen>
