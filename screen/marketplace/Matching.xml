<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-3.xsd"
        default-menu-title="æ™ºèƒ½åŒ¹é…" require-authentication="false">

    <parameter name="merchantId"/>
    <parameter name="listingId"/>
    <parameter name="minScore"/>
    <parameter name="maxResults"/>
    <parameter name="matchMode" default="traditional"/>
    <parameter name="projectDescription"/>

    <actions>
        <if condition="!merchantId">
            <set field="merchantId" value="__ALL__"/>
        </if>
        <script><![CDATA[
            import java.math.BigDecimal
            import java.math.RoundingMode

            def isAllMerchant = !merchantId || "__ALL__".equalsIgnoreCase(merchantId) || "ALL".equalsIgnoreCase(merchantId)
            displayMerchantName = isAllMerchant ? "å…¨éƒ¨å•†æˆ·" : merchantId

            candidateListings = []
            matchResults = []
            matchError = null
            projectCategory = null
            projectConfidencePercent = null
            projectClassificationMessage = null

            def resolvedMatchMode = (matchMode ?: "traditional").toLowerCase()
            matchMode = resolvedMatchMode in ["project", "traditional"] ? resolvedMatchMode : "traditional"

            if (matchMode == "project" && projectDescription) {
                try {
                    Map classifyResult = ec.service.sync().name("mcp.routing.classify#UserIntent").parameters([
                        userMessage: projectDescription,
                        messageType: "text"
                    ]).call()
                    projectCategory = classifyResult.businessCategory ?: "SUPPLY_DEMAND_MATCHING"
                    BigDecimal confidence = classifyResult.confidence instanceof BigDecimal ?
                            (BigDecimal) classifyResult.confidence :
                            new BigDecimal(classifyResult.confidence?.toString() ?: "0")
                    confidence = confidence.max(BigDecimal.ZERO).min(BigDecimal.ONE)
                    projectConfidencePercent = confidence.multiply(new BigDecimal("100")).setScale(0, RoundingMode.HALF_UP)
                    projectClassificationMessage = "è¯†åˆ«ä¸ºï¼š${projectCategory}ï¼Œç½®ä¿¡åº¦ ${projectConfidencePercent}%"
                } catch (Exception e) {
                    ec.logger.warn("é¡¹ç›®åŒ¹é…åˆ†ç±»å¤±è´¥: ${e.message}")
                    projectClassificationMessage = "æ™ºèƒ½è¯†åˆ«æš‚ä¸å¯ç”¨ï¼Œè¯·æ”¹ç”¨ä¼ ç»Ÿæ¨¡å¼ã€‚"
                }
            }

            def listingTypeFilter = matchMode == "project" && projectCategory == "HIVEMIND_PROJECT" ? "DEMAND" : null

            def listingFind = ec.entity.find("marketplace.listing.Listing")
                .orderBy("-createdDate")
                .limit(30)
            if (!isAllMerchant) listingFind.condition("publisherId", merchantId)
            if (listingTypeFilter) listingFind.condition("listingType", listingTypeFilter)
            listingFind.disableAuthz()
            listingFind.list().each { listing ->
                candidateListings.add([
                    listingId   : listing.listingId,
                    title       : listing.title ?: listing.listingId,
                    listingType : listing.listingType ?: "SUPPLY",
                    status      : listing.status ?: "ACTIVE",
                    createdDate : listing.createdDate
                ])
            }

            selectedListingId = listingId
            if (!selectedListingId && candidateListings) selectedListingId = candidateListings[0].listingId

            selectedMinScore = (minScore ?: "0.6").toString()
            selectedMaxResults = (maxResults ?: "20").toString()

            Closure<Map> getListingInfo = { String id ->
                if (!id) return [title: id]
                def infoFind = ec.entity.find("marketplace.listing.Listing")
                    .condition("listingId", id)
                infoFind.disableAuthz()
                def value = infoFind.one()
                return [
                    title      : value?.title ?: id,
                    listingType: value?.listingType ?: "",
                    publisherId: value?.publisherId
                ]
            }

            if (selectedListingId) {
                try {
                    Map resp = ec.service.sync().name("marketplace.MarketplaceServices.find#Matches")
                        .parameters([
                            listingId : selectedListingId,
                            minScore  : new BigDecimal(selectedMinScore),
                            maxResults: Integer.valueOf(selectedMaxResults)
                        ]).call()
                    List<Map<String,Object>> serviceMatches = resp.matches ?: []
                    serviceMatches.each { item ->
                        Map supplyInfo = getListingInfo(item.supplyListingId)
                        Map demandInfo = getListingInfo(item.demandListingId)
                        BigDecimal score = item.matchScore ?: BigDecimal.ZERO
                        matchResults.add([
                            matchId           : item.matchId ?: "",
                            supplyListingId   : item.supplyListingId,
                            supplyTitle       : supplyInfo.title,
                            demandListingId   : item.demandListingId,
                            demandTitle       : demandInfo.title,
                            matchScorePercent : score.multiply(new BigDecimal("100")).setScale(1, RoundingMode.HALF_UP),
                            status            : item.status ?: "SUGGESTED",
                            suggestedDate     : item.suggestedDate ?: item.createdDate
                        ])
                    }
                } catch (Exception e) {
                    matchError = e.message
                    ec.logger.warn("åŒ¹é…æœåŠ¡å¤±è´¥: ${e.message}")
                }
            }
        ]]></script>
    </actions>

    <widgets>
        <container>
            <label text="ðŸ¤– æ™ºèƒ½åŒ¹é…æŽ§åˆ¶å°" type="h5" style="q-mb-md"/>
            <label text="å½“å‰è§†è§’ï¼š${displayMerchantName}" type="p"/>
        </container>

        <container style="q-card q-mb-md">
            <container style="q-card__section">
                <form-single name="ModeForm" method="get">
                    <container-row>
                        <row-col lg="4" md="6" sm="12">
                            <field name="matchMode">
                                <default-field title="åŒ¹é…æ¨¡å¼">
                                    <drop-down>
                                        <option key="traditional" text="ä¼ ç»Ÿæ’®åˆ"/>
                                        <option key="project" text="é¡¹ç›®åŒ¹é…"/>
                                    </drop-down>
                                </default-field>
                            </field>
                        </row-col>
                        <row-col lg="4" md="6" sm="12">
                            <field name="projectDescription" condition="${matchMode == 'project'}">
                                <default-field title="é¡¹ç›®éœ€æ±‚æè¿°">
                                    <text-area rows="2" cols="40" default-value="${projectDescription ?: ''}"/>
                                </default-field>
                            </field>
                        </row-col>
                        <row-col lg="4" md="12" sm="12" style="align-items:flex-end; display:flex;">
                            <field name="modeSubmit">
                                <default-field title="">
                                    <submit text="åº”ç”¨æ¨¡å¼"/>
                                </default-field>
                            </field>
                        </row-col>
                    </container-row>
                </form-single>
                <if condition="${projectClassificationMessage}">
                    <label text="${projectClassificationMessage}" type="p" style="color:#1976d2;"/>
                </if>
            </container>
        </container>

        <form-single name="MatchingFilterForm" method="get">
            <field name="merchantId">
                <default-field title="å•†æˆ·ID">
                    <text-line size="25" default-value="${(merchantId == '__ALL__' || merchantId == 'ALL') ? '' : merchantId}"/>
                </default-field>
            </field>
            <field name="listingId">
                <default-field title="é€‰æ‹©ä¾›éœ€ä¿¡æ¯">
                    <drop-down>
                        <option key="" text="è‡ªåŠ¨é€‰æ‹©æœ€æ–°è®°å½•"/>
                        <list-options list="candidateListings" key-field="listingId" text-field="title"/>
                    </drop-down>
                </default-field>
            </field>
            <field name="minScore">
                <default-field title="æœ€ä½ŽåŒ¹é…åº¦(0~1)">
                    <text-line size="6" default-value="${minScore ?: '0.6'}"/>
                </default-field>
            </field>
            <field name="maxResults">
                <default-field title="æœ€å¤§ç»“æžœæ•°">
                    <text-line size="6" default-value="${maxResults ?: '20'}"/>
                </default-field>
            </field>
            <field name="submit">
                <default-field title="">
                    <submit text="é‡æ–°åŒ¹é…"/>
                </default-field>
            </field>
        </form-single>

        <if condition="matchError">
            <label text="åŒ¹é…å¤±è´¥ï¼š${matchError}" type="p" style="text-danger"/>
        </if>

        <container>
            <label text="åŒ¹é…ç»“æžœ" type="h4"/>
            <container style="table table-striped">
                <container style="thead">
                    <container style="tr">
                        <container style="th"><label text="åŒ¹é…ID"/></container>
                        <container style="th"><label text="ä¾›åº”ä¿¡æ¯"/></container>
                        <container style="th"><label text="éœ€æ±‚ä¿¡æ¯"/></container>
                        <container style="th"><label text="åŒ¹é…åº¦(%)"/></container>
                        <container style="th"><label text="çŠ¶æ€"/></container>
                        <container style="th"><label text="æ—¶é—´"/></container>
                    </container>
                </container>
                <container style="tbody">
                    <section-iterate name="MatchResultIterate" list="matchResults" entry="match">
                        <widgets>
                            <container style="tr">
                                <container style="td"><label text="${match.matchId ?: 'â€”'}"/></container>
                                <container style="td"><label text="${match.supplyTitle ?: 'â€”'}"/></container>
                                <container style="td"><label text="${match.demandTitle ?: 'â€”'}"/></container>
                                <container style="td"><label text="${match.matchScorePercent ?: 'â€”'}"/></container>
                                <container style="td"><label text="${match.status ?: 'â€”'}"/></container>
                                <container style="td"><label text="${match.suggestedDate ? ec.l10n.format(match.suggestedDate, 'yyyy-MM-dd HH:mm') : 'â€”'}"/></container>
                            </container>
                        </widgets>
                    </section-iterate>
                </container>
            </container>
        </container>
    </widgets>
</screen>
