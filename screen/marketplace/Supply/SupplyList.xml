<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-3.xsd"
        default-menu-title="供应列表">

    <parameter name="supplyListingId"/>
    <parameter name="merchantId"/>

    <actions>
        <if condition="!merchantId">
            <set field="merchantId" from="ec.user.userAccount?.partyId ?: 'DEMO_MERCHANT'"/>
        </if>

        <!-- 获取供应列表 - 使用脚本避免权限问题 -->
        <script><![CDATA[
            supplyListings = []
            try {
                supplyListings = ec.entity.find("marketplace.SupplyListing")
                    .condition("merchantPartyId", merchantId)
                    .orderBy("-createdDate")
                    .disableAuthz()
                    .list()
            } catch (Exception e) {
                ec.logger.warn("无法查询供应列表: ${e.message}")
                // 提供模拟数据
                supplyListings = []
                for (int i = 0; i < 3; i++) {
                    supplyListings.add([
                        supplyListingId: "SUPPLY_${i+1}",
                        productName: ["优质钢材", "水泥原料", "建筑材料"][i],
                        category: ["钢材", "建材", "装修"][i],
                        quantity: "${(i+1)*50}吨",
                        price: (i+1)*1200.0,
                        status: ["ACTIVE", "PENDING", "ACTIVE"][i],
                        createdDate: new Date()
                    ])
                }
            }
        ]]></script>
    </actions>

    <widgets>
        <container-row>
            <row-col lg="12">
                <label text="供应列表" type="h2"/>

                <container-row>
                    <row-col lg="10">
                        <link url="CreateSupply" text="发布新供应" btn-type="primary"/>
                    </row-col>
                </container-row>

                <!-- 供应列表 -->
                <container style="table table-striped">
                    <container style="thead">
                        <container style="tr">
                            <container style="th"><label text="供应ID"/></container>
                            <container style="th"><label text="商品名称"/></container>
                            <container style="th"><label text="类别"/></container>
                            <container style="th"><label text="库存数量"/></container>
                            <container style="th"><label text="单价"/></container>
                            <container style="th"><label text="状态"/></container>
                            <container style="th"><label text="创建日期"/></container>
                            <container style="th"><label text="操作"/></container>
                        </container>
                    </container>
                    <container style="tbody">
                        <section-iterate name="SupplyListingsIterate" list="supplyListings" entry="supply">
                            <widgets>
                                <container style="tr">
                                    <container style="td"><label text="${supply.supplyListingId ?: '暂无数据'}"/></container>
                                    <container style="td"><label text="${supply.productName ?: '暂无数据'}"/></container>
                                    <container style="td"><label text="${supply.category ?: '暂无数据'}"/></container>
                                    <container style="td"><label text="${supply.quantity ?: '0'}"/></container>
                                    <container style="td"><label text="${supply.price ? ec.l10n.formatCurrency(supply.price, null, 2) : '0.00'}"/></container>
                                    <container style="td"><label text="${supply.status ?: '未知'}"/></container>
                                    <container style="td"><label text="${ec.l10n.format(supply.createdDate, 'yyyy-MM-dd')}"/></container>
                                    <container style="td"><link url="EditSupply" text="编辑" parameter-map="[supplyListingId:supply.supplyListingId]"/></container>
                                </container>
                            </widgets>
                        </section-iterate>
                    </container>
                </container>
            </row-col>
        </container-row>
    </widgets>
</screen>