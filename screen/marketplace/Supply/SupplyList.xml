<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-3.xsd"
        default-menu-title="‰æõÂ∫îÂàóË°®">

    <parameter name="merchantId"/>

    <actions>
        <if condition="!merchantId">
            <set field="merchantId" from="ec.user.userAccount?.partyId ?: 'DEMO_MERCHANT'"/>
        </if>

        <!-- Ëé∑Âèñ‰æõÂ∫îÂàóË°® - ‰ΩøÁî®ËÑöÊú¨ÈÅøÂÖçÊùÉÈôêÈóÆÈ¢ò -->
        <script><![CDATA[
            List<Map> normalizedList = []
            try {
                def queryResults = ec.entity.find("marketplace.SupplyListing")
                        .condition("publisherId", merchantId)
                        .orderBy("-createdDate")
                        .disableAuthz()
                        .list()
                for (def value : queryResults) {
                    Map entry = value instanceof Map ? new LinkedHashMap(value as Map) : new LinkedHashMap(value.getMap(false))
                    entry.listingId = entry.listingId ?: entry.supplyListingId
                    entry.title = entry.title ?: entry.productName ?: "Êú™ÂëΩÂêçÂïÜÂìÅ"
                    entry.displayQuantity = entry.quantity ?: entry.stockQuantity
                    entry.displayPrice = entry.priceMin ?: entry.price ?: entry.unitPrice
                    normalizedList.add(entry)
                }
            } catch (Exception e) {
                ec.logger.warn("Êó†Ê≥ïÊü•ËØ¢‰æõÂ∫îÂàóË°®: ${e.message}")
                for (int i = 0; i < 3; i++) {
                    normalizedList.add([
                        listingId      : "SUPPLY_${i + 1}",
                        title          : ["‰ºòË¥®Èí¢Êùê", "Ê∞¥Ê≥•ÂéüÊñô", "Âª∫Á≠ëÊùêÊñô"][i],
                        category       : ["Èí¢Êùê", "Âª∫Êùê", "Ë£Ö‰øÆ"][i],
                        displayQuantity: "${(i + 1) * 50}Âê®",
                        displayPrice   : (i + 1) * 1200.0G,
                        status         : ["ACTIVE", "PENDING", "ACTIVE"][i],
                        createdDate    : new Date()
                    ])
                }
            }
            supplyListings = normalizedList
        ]]></script>
    </actions>

    <widgets>
        <container-row>
            <row-col lg="12">
                <label text="üì¶ ‰æõÂ∫îÂàóË°®" type="h5" style="q-mb-md"/>

                <container-row>
                    <row-col lg="10">
                        <link url="CreateSupply" text="ÂèëÂ∏ÉÊñ∞‰æõÂ∫î" btn-type="primary"/>
                    </row-col>
                </container-row>

                <!-- ‰æõÂ∫îÂàóË°® -->
                <container style="table table-striped">
                    <container style="thead">
                        <container style="tr">
                            <container style="th"><label text="‰æõÂ∫îID"/></container>
                            <container style="th"><label text="ÂïÜÂìÅÂêçÁß∞"/></container>
                            <container style="th"><label text="Á±ªÂà´"/></container>
                            <container style="th"><label text="Â∫ìÂ≠òÊï∞Èáè"/></container>
                            <container style="th"><label text="Âçï‰ª∑"/></container>
                            <container style="th"><label text="Áä∂ÊÄÅ"/></container>
                            <container style="th"><label text="ÂàõÂª∫Êó•Êúü"/></container>
                            <container style="th"><label text="Êìç‰Ωú"/></container>
                        </container>
                    </container>
                    <container style="tbody">
                        <section-iterate name="SupplyListingsIterate" list="supplyListings" entry="supply">
                            <widgets>
                                <container style="tr">
                                    <container style="td"><label text="${supply.listingId ?: 'ÊöÇÊó†Êï∞ÊçÆ'}"/></container>
                                    <container style="td"><label text="${supply.title ?: 'ÊöÇÊó†Êï∞ÊçÆ'}"/></container>
                                    <container style="td"><label text="${supply.category ?: 'ÊöÇÊó†Êï∞ÊçÆ'}"/></container>
                                    <container style="td"><label text="${supply.displayQuantity ?: (supply.quantity ?: '0')}"/></container>
                                    <container style="td">
                                        <label text="${supply.displayPrice ? ec.l10n.formatCurrency(supply.displayPrice, null, 2) : (supply.priceMin ? ec.l10n.formatCurrency(supply.priceMin, null, 2) : '0.00')}"/>
                                    </container>
                                    <container style="td"><label text="${supply.status ?: 'Êú™Áü•'}"/></container>
                                    <container style="td"><label text="${ec.l10n.format(supply.createdDate, 'yyyy-MM-dd')}"/></container>
                                    <container style="td"><link url="EditSupply" text="ÁºñËæë" parameter-map="[listingId:supply.listingId]"/></container>
                                </container>
                            </widgets>
                        </section-iterate>
                    </container>
                </container>
            </row-col>
        </container-row>
    </widgets>
</screen>
