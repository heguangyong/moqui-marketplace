<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-3.xsd"
        default-menu-title="供应列表">

    <parameter name="merchantId"/>

    <actions>
        <if condition="!merchantId">
            <set field="merchantId" from="ec.user.userAccount?.partyId ?: 'DEMO_MERCHANT'"/>
        </if>

        <!-- 获取供应列表 - 使用脚本避免权限问题 -->
        <script><![CDATA[
            List<Map> normalizedList = []
            try {
                def queryResults = ec.entity.find("marketplace.SupplyListing")
                        .condition("publisherId", merchantId)
                        .orderBy("-createdDate")
                        .disableAuthz()
                        .list()
                for (def value : queryResults) {
                    Map entry = value instanceof Map ? new LinkedHashMap(value as Map) : new LinkedHashMap(value.getMap(false))
                    entry.listingId = entry.listingId ?: entry.supplyListingId
                    entry.title = entry.title ?: entry.productName ?: "未命名商品"
                    entry.displayQuantity = entry.quantity ?: entry.stockQuantity
                    entry.displayPrice = entry.priceMin ?: entry.price ?: entry.unitPrice
                    normalizedList.add(entry)
                }
            } catch (Exception e) {
                ec.logger.warn("无法查询供应列表: ${e.message}")
                for (int i = 0; i < 3; i++) {
                    normalizedList.add([
                        listingId      : "SUPPLY_${i + 1}",
                        title          : ["优质钢材", "水泥原料", "建筑材料"][i],
                        category       : ["钢材", "建材", "装修"][i],
                        displayQuantity: "${(i + 1) * 50}吨",
                        displayPrice   : (i + 1) * 1200.0G,
                        status         : ["ACTIVE", "PENDING", "ACTIVE"][i],
                        createdDate    : new Date()
                    ])
                }
            }
            supplyListings = normalizedList
        ]]></script>
    </actions>

    <widgets>
        <container-row>
            <row-col lg="12">
                <label text="供应列表" type="h2"/>

                <container-row>
                    <row-col lg="10">
                        <link url="CreateSupply" text="发布新供应" btn-type="primary"/>
                    </row-col>
                </container-row>

                <!-- 供应列表 -->
                <container style="table table-striped">
                    <container style="thead">
                        <container style="tr">
                            <container style="th"><label text="供应ID"/></container>
                            <container style="th"><label text="商品名称"/></container>
                            <container style="th"><label text="类别"/></container>
                            <container style="th"><label text="库存数量"/></container>
                            <container style="th"><label text="单价"/></container>
                            <container style="th"><label text="状态"/></container>
                            <container style="th"><label text="创建日期"/></container>
                            <container style="th"><label text="操作"/></container>
                        </container>
                    </container>
                    <container style="tbody">
                        <section-iterate name="SupplyListingsIterate" list="supplyListings" entry="supply">
                            <widgets>
                                <container style="tr">
                                    <container style="td"><label text="${supply.listingId ?: '暂无数据'}"/></container>
                                    <container style="td"><label text="${supply.title ?: '暂无数据'}"/></container>
                                    <container style="td"><label text="${supply.category ?: '暂无数据'}"/></container>
                                    <container style="td"><label text="${supply.displayQuantity ?: (supply.quantity ?: '0')}"/></container>
                                    <container style="td">
                                        <label text="${supply.displayPrice ? ec.l10n.formatCurrency(supply.displayPrice, null, 2) : (supply.priceMin ? ec.l10n.formatCurrency(supply.priceMin, null, 2) : '0.00')}"/>
                                    </container>
                                    <container style="td"><label text="${supply.status ?: '未知'}"/></container>
                                    <container style="td"><label text="${ec.l10n.format(supply.createdDate, 'yyyy-MM-dd')}"/></container>
                                    <container style="td"><link url="EditSupply" text="编辑" parameter-map="[listingId:supply.listingId]"/></container>
                                </container>
                            </widgets>
                        </section-iterate>
                    </container>
                </container>
            </row-col>
        </container-row>
    </widgets>
</screen>
