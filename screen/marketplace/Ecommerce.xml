<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-3.xsd"
        default-menu-title="ÊµÅË°åÁîµÂïÜ"
        require-authentication="false">

    <actions>
        <script><![CDATA[
            import org.moqui.entity.EntityCondition
            import java.time.LocalDate
            import java.time.ZoneId
            import java.math.BigDecimal
            import java.math.RoundingMode

            productStats = [total: 0, active: 0, lowStock: 0, categories: 0]
            productCategoryName = [:]
            recentProducts = []
            lowStockProducts = []
            orderStats = [total: 0, open: 0, today: 0]
            statusSummary = [:]
            recentOrders = []
            openOrders = []
            categorySales = []
            topCustomers = []

            try {
                def categoryList = ec.entity.find("marketplace.ecommerce.EcommerceProductCategory")
                        .disableAuthz().list()
                categoryList?.each { cat ->
                    productCategoryName[cat.productCategoryId] = cat.categoryName ?: cat.productCategoryId
                }
            } catch (Exception e) {
                ec.logger.warn("Êó†Ê≥ïÂä†ËΩΩÁîµÂïÜÂàÜÁ±ª: ${e.message}")
            }

            try {
                def productList = ec.entity.find("marketplace.ecommerce.EcommerceProduct")
                        .disableAuthz().list()
                productStats.total = productList?.size() ?: 0
                productStats.active = productList?.count { "ACTIVE".equalsIgnoreCase(it.status ?: "") } ?: 0
                productStats.lowStock = productList?.count {
                    def qty = it.stockQuantity instanceof Number ? ((Number) it.stockQuantity).longValue() : 0L
                    qty < 10L
                } ?: 0
                Set categorySet = new LinkedHashSet(productList?.collect { it.productCategoryId }?.findAll { it })
                productStats.categories = categorySet?.size() ?: 0

                recentProducts = productList?.sort { a, b ->
                    def tsA = a.lastUpdatedDate ?: a.createdDate
                    def tsB = b.lastUpdatedDate ?: b.createdDate
                    (tsB?.time ?: 0) <=> (tsA?.time ?: 0)
                }?.take(6) ?: []

                lowStockProducts = productList?.findAll {
                    def qty = it.stockQuantity instanceof Number ? ((Number) it.stockQuantity).longValue() : 0L
                    qty in 0..<10
                }?.sort { it.stockQuantity ?: 0 }?.take(5) ?: []
            } catch (Exception e) {
                ec.logger.warn("Âä†ËΩΩÂïÜÂìÅÁªüËÆ°Â§±Ë¥•: ${e.message}")
            }

            try {
                def orderFind = ec.entity.find("marketplace.ecommerce.EcommerceOrder")
                        .orderBy("-createdDate")
                        .limit(20)
                        .disableAuthz()
                def orders = orderFind.list()
                orderStats.total = ec.entity.find("marketplace.ecommerce.EcommerceOrder").disableAuthz().count() ?: 0
                statusSummary = orders?.groupBy { it.orderStatus ?: "UNKNOWN" }?.collectEntries { k, v -> [(k): v.size()] } ?: [:]

                def openStatuses = ["CREATED","PAID","PROCESSING"]
                orderStats.open = ec.entity.find("marketplace.ecommerce.EcommerceOrder")
                        .condition("orderStatus", EntityCondition.IN, openStatuses)
                        .disableAuthz()
                        .count() ?: 0

                LocalDate today = LocalDate.now(ZoneId.systemDefault())
                long startOfDay = today.atStartOfDay(ZoneId.systemDefault()).toInstant().toEpochMilli()
                orderStats.today = orders?.count { it.createdDate && it.createdDate.time >= startOfDay } ?: 0

                recentOrders = orders?.take(6) ?: []
                openOrders = orders?.findAll { (it.orderStatus ?: "") in openStatuses }?.take(5) ?: []
            } catch (Exception e) {
                ec.logger.warn("Âä†ËΩΩËÆ¢ÂçïÁªüËÆ°Â§±Ë¥•: ${e.message}")
            }

            try {
                def itemList = ec.entity.find("marketplace.ecommerce.EcommerceOrderItem").disableAuthz().list()
                Map<String, Map> productCache = [:]
                Map<String, Map> categoryAgg = [:]
                itemList?.each { itemVal ->
                    String productId = itemVal.ecommerceProductId
                    if (!productId) return
                    Map prod = productCache[productId]
                    if (!prod) {
                        prod = ec.entity.find("marketplace.ecommerce.EcommerceProduct")
                                .condition("ecommerceProductId", productId)
                                .disableAuthz().one()?.getMap(false)
                        productCache[productId] = prod
                    }
                    String categoryId = prod?.productCategoryId ?: "UNSPECIFIED"
                    BigDecimal itemTotal = itemVal.itemTotal instanceof BigDecimal ?
                            (BigDecimal) itemVal.itemTotal :
                            (itemVal.itemTotal ? new BigDecimal(itemVal.itemTotal.toString()) : BigDecimal.ZERO)
                    Map agg = categoryAgg[categoryId] ?: [total: BigDecimal.ZERO, quantity: 0L]
                    agg.total = agg.total.add(itemTotal ?: BigDecimal.ZERO)
                    Long qty = itemVal.quantity instanceof Number ? ((Number) itemVal.quantity).longValue() : 0L
                    agg.quantity = agg.quantity + qty
                    categoryAgg[categoryId] = agg
                }
                categorySales = categoryAgg.collect { cid, agg ->
                    [
                        categoryId  : cid,
                        categoryName: productCategoryName[cid] ?: (cid == "UNSPECIFIED" ? "Êú™ÂàÜÁ±ª" : cid),
                        totalAmount : agg.total,
                        quantity    : agg.quantity
                    ]
                }.sort { a, b -> (b.totalAmount ?: BigDecimal.ZERO) <=> (a.totalAmount ?: BigDecimal.ZERO) }.take(6)
            } catch (Exception e) {
                ec.logger.warn("ÁªüËÆ°ÂìÅÁ±ªÈîÄÂîÆÂ§±Ë¥•: ${e.message}")
            }

            try {
                def orders = ec.entity.find("marketplace.ecommerce.EcommerceOrder").disableAuthz().list()
                Map<String, Map> customerAgg = [:]
                orders?.each { orderVal ->
                    String customerId = orderVal.ecommerceCustomerId ?: "UNASSIGNED"
                    Map agg = customerAgg[customerId] ?: [orders: 0, amount: BigDecimal.ZERO]
                    agg.orders = agg.orders + 1
                    BigDecimal orderTotal = orderVal.orderTotal instanceof BigDecimal ?
                            (BigDecimal) orderVal.orderTotal :
                            (orderVal.orderTotal ? new BigDecimal(orderVal.orderTotal.toString()) : BigDecimal.ZERO)
                    agg.amount = agg.amount.add(orderTotal ?: BigDecimal.ZERO)
                    customerAgg[customerId] = agg
                }
                topCustomers = customerAgg.collect { cid, agg ->
                    [
                        ecommerceCustomerId: cid,
                        customerName       : cid,
                        orderCount         : agg.orders,
                        totalAmount        : agg.amount
                    ]
                }.sort { a, b -> (b.totalAmount ?: BigDecimal.ZERO) <=> (a.totalAmount ?: BigDecimal.ZERO) }.take(5)

                // Â°´ÂÖÖÂÆ¢Êà∑ÂêçÁß∞
                topCustomers.each { Map cust ->
                    if (cust.ecommerceCustomerId && cust.ecommerceCustomerId != "UNASSIGNED") {
                        def customerValue = ec.entity.find("marketplace.ecommerce.EcommerceCustomer")
                                .condition("ecommerceCustomerId", cust.ecommerceCustomerId)
                                .disableAuthz().one()
                        if (customerValue) {
                            cust.customerName = customerValue.fullName ?: customerValue.ecommerceCustomerId
                        }
                    }
                }
            } catch (Exception e) {
                ec.logger.warn("ÁªüËÆ°ÂÆ¢Êà∑‰ø°ÊÅØÂ§±Ë¥•: ${e.message}")
            }
        ]]></script>
    </actions>

    <widgets>
        <!-- È°µÈù¢Ê†áÈ¢òÂå∫Âüü -->
        <container style="q-pa-md">
            <container style="q-mb-md">
                <label text="üõçÔ∏è ÊµÅË°åÁîµÂïÜÊéßÂà∂Âè∞" type="h4"/>
                <label text="Âü∫‰∫é Telegram ÁöÑÂïÜÂìÅ„ÄÅÂ∫ìÂ≠ò‰∏éËÆ¢ÂçïÂçèÂêå‰∏≠ÂøÉ" style="color: #666; font-size: 14px;"/>
            </container>

            <!-- ÂÖ≥ÈîÆÁªüËÆ°Âç°Áâá -->
            <container style="q-mb-md">
                <label text="üìä ‰∏öÂä°Ê¶ÇËßà" type="h5" style="q-mb-sm"/>
                <container style="row q-gutter-md">
                    <container style="col q-card q-pa-md">
                        <container style="text-center">
                            <label text="ÂïÜÂìÅÊÄªÊï∞" style="font-size: 14px; color: #666;"/>
                            <container style="q-mt-sm">
                                <label text="${productStats.total ?: 0}" style="font-size: 24px; font-weight: bold; color: #1976d2;"/>
                                <label text="ÊÄªÊï∞" style="font-size: 12px; color: #666; margin-left: 8px;"/>
                            </container>
                            <container style="q-mt-xs">
                                <label text="${productStats.active ?: 0}" style="font-size: 16px; color: #4caf50;"/>
                                <label text="Ê¥ªË∑É" style="font-size: 12px; color: #666; margin-left: 4px;"/>
                            </container>
                        </container>
                    </container>

                    <container style="col q-card q-pa-md">
                        <container style="text-center">
                            <label text="Â∫ìÂ≠òÈ¢ÑË≠¶" style="font-size: 14px; color: #666;"/>
                            <container style="q-mt-sm">
                                <label text="${productStats.lowStock ?: 0}" style="font-size: 24px; font-weight: bold; color: #ff9800;"/>
                                <label text="‰ΩéÂ∫ìÂ≠ò" style="font-size: 12px; color: #666; margin-left: 8px;"/>
                            </container>
                            <container style="q-mt-xs">
                                <label text="ÈòàÂÄº &lt; 10" style="font-size: 12px; color: #666;"/>
                            </container>
                        </container>
                    </container>

                    <container style="col q-card q-pa-md">
                        <container style="text-center">
                            <label text="ÂæÖÂ§ÑÁêÜËÆ¢Âçï" style="font-size: 14px; color: #666;"/>
                            <container style="q-mt-sm">
                                <label text="${orderStats.open ?: 0}" style="font-size: 24px; font-weight: bold; color: #009688;"/>
                                <label text="ÂæÖÂ§ÑÁêÜ" style="font-size: 12px; color: #666; margin-left: 8px;"/>
                            </container>
                            <container style="q-mt-xs">
                                <label text="${orderStats.today ?: 0}" style="font-size: 16px; color: #ff5722;"/>
                                <label text="‰ªäÊó•Êñ∞Âª∫" style="font-size: 12px; color: #666; margin-left: 4px;"/>
                            </container>
                        </container>
                    </container>

                    <container style="col q-card q-pa-md">
                        <container style="text-center">
                            <label text="ÂìÅÁ±ªË¶ÜÁõñ" style="font-size: 14px; color: #666;"/>
                            <container style="q-mt-sm">
                                <label text="${productStats.categories ?: 0}" style="font-size: 24px; font-weight: bold; color: #9c27b0;"/>
                                <label text="ÁßçÁ±ª" style="font-size: 12px; color: #666; margin-left: 8px;"/>
                            </container>
                            <container style="q-mt-xs">
                                <label text="Telegram ÂêåÊ≠•" style="font-size: 12px; color: #666;"/>
                            </container>
                        </container>
                    </container>
                </container>
            </container>

            <!-- Â∏∏Áî®Êìç‰ΩúÂå∫Âüü -->
            <container style="q-card q-pa-md q-mb-md">
                <label text="‚ö° Â∏∏Áî®Êìç‰Ωú" type="h5" style="q-mb-md"/>
                <container style="row q-gutter-md q-mb-md">
                    <link url="#" text="‚ûï Telegram /product add" btn-type="primary" style="col" transition="false"/>
                    <link url="#" text="üõí Telegram /order create" btn-type="secondary" style="col" transition="false"/>
                    <link url="../Dashboard" text="üìä Êô∫ËÉΩÂåπÈÖçÊéßÂà∂Âè∞" btn-type="accent" style="col"/>
                    <link url="../SystemConfig" text="‚öôÔ∏è Á≥ªÁªüÈÖçÁΩÆ" btn-type="warning" style="col"/>
                </container>
                <container style="q-pa-sm bg-blue-1 text-blue-8 rounded-borders">
                    <label text="üí° ÊèêÁ§∫ÔºöÊåá‰ª§ÂùáÂú® Telegram Bot ‰∏≠ÊâßË°åÔºåWeb ÊéßÂà∂Âè∞‰ªÖÁî®‰∫éÁõëÊéß‰∏éÊ†°È™å„ÄÇ" style="font-size: 12px;"/>
                </container>
            </container>

            <!-- Êï∞ÊçÆË°®Ê†ºÂå∫Âüü -->
            <container style="row q-gutter-md q-mb-md">
                <container style="col-6 q-card q-pa-md">
                    <label text="üì¶ ÊúÄÊñ∞ÂïÜÂìÅ" type="h6" style="q-mb-md"/>
                    <if condition="recentProducts">
                        <container style="q-table__container">
                            <container style="q-table__table">
                                <container style="thead">
                                    <container style="tr">
                                        <container style="th text-left"><label text="ÂêçÁß∞"/></container>
                                        <container style="th text-left"><label text="ÂàÜÁ±ª"/></container>
                                        <container style="th text-right"><label text="‰ª∑Ê†º"/></container>
                                        <container style="th text-right"><label text="Â∫ìÂ≠ò"/></container>
                                    </container>
                                </container>
                                <container style="tbody">
                                    <section-iterate list="recentProducts" entry="product">
                                        <widgets>
                                            <container style="tr">
                                                <container style="td"><label text="${product.productName ?: product.ecommerceProductId}" style="font-weight: 500;"/></container>
                                                <container style="td"><label text="${productCategoryName[product.productCategoryId] ?: product.productCategoryId ?: '‚Äî'}" style="color: #666;"/></container>
                                                <container style="td text-right"><label text="${product.price ? ec.l10n.formatCurrency(product.price, product.currencyUomId ?: 'CNY') : '‚Äî'}" style="color: #1976d2;"/></container>
                                                <container style="td text-right"><label text="${product.stockQuantity ?: 0}" style="color: ${(product.stockQuantity ?: 0) &lt; 10 ? '#ff5722' : '#4caf50'};"/></container>
                                            </container>
                                        </widgets>
                                    </section-iterate>
                                </container>
                            </container>
                        </container>
                    </if>
                    <if condition="!recentProducts">
                        <container style="text-center q-pa-md text-grey-6">
                            <label text="ÊöÇÊó†ÂïÜÂìÅËÆ∞ÂΩï"/>
                        </container>
                    </if>
                </container>

                <container style="col-6 q-card q-pa-md">
                    <label text="üõí ÊúÄÊñ∞ËÆ¢Âçï" type="h6" style="q-mb-md"/>
                    <if condition="recentOrders">
                        <container style="q-table__container">
                            <container style="q-table__table">
                                <container style="thead">
                                    <container style="tr">
                                        <container style="th text-left"><label text="ËÆ¢Âçï"/></container>
                                        <container style="th text-left"><label text="Áä∂ÊÄÅ"/></container>
                                        <container style="th text-right"><label text="ÈáëÈ¢ù"/></container>
                                        <container style="th text-left"><label text="ÂÆ¢Êà∑"/></container>
                                    </container>
                                </container>
                                <container style="tbody">
                                    <section-iterate list="recentOrders" entry="order">
                                        <widgets>
                                            <container style="tr">
                                                <container style="td"><label text="${order.ecommerceOrderId}" style="font-weight: 500;"/></container>
                                                <container style="td"><label text="${order.orderStatus ?: '‚Äî'}" style="color: #666;"/></container>
                                                <container style="td text-right"><label text="${order.orderTotal ? ec.l10n.formatCurrency(order.orderTotal, order.currencyUomId ?: 'CNY') : '‚Äî'}" style="color: #4caf50;"/></container>
                                                <container style="td"><label text="${order.ecommerceCustomerId ?: '‚Äî'}" style="color: #666;"/></container>
                                            </container>
                                        </widgets>
                                    </section-iterate>
                                </container>
                            </container>
                        </container>
                    </if>
                    <if condition="!recentOrders">
                        <container style="text-center q-pa-md text-grey-6">
                            <label text="ÊöÇÊó†ËÆ¢ÂçïËÆ∞ÂΩï"/>
                        </container>
                    </if>
                </container>
            </container>

            <!-- Áä∂ÊÄÅÂàÜÊûêÂå∫Âüü -->
            <container style="row q-gutter-md q-mb-md">
                <container style="col-6 q-card q-pa-md">
                    <label text="üìä ËÆ¢ÂçïÁä∂ÊÄÅÂàÜÂ∏É" type="h6" style="q-mb-md"/>
                    <if condition="statusSummary">
                        <section-iterate list="statusSummary.entrySet()" entry="entry">
                            <widgets>
                                <container style="row justify-between items-center q-py-sm border-bottom">
                                    <label text="${entry.key}" style="font-weight: 500;"/>
                                    <container style="q-px-sm q-py-xs bg-blue-1 text-blue-8 rounded-borders">
                                        <label text="${entry.value}"/>
                                    </container>
                                </container>
                            </widgets>
                        </section-iterate>
                    </if>
                    <if condition="!statusSummary || statusSummary.isEmpty()">
                        <container style="text-center q-pa-md text-grey-6">
                            <label text="ÊöÇÊó†Áä∂ÊÄÅÊï∞ÊçÆ"/>
                        </container>
                    </if>
                </container>

                <container style="col-6 q-card q-pa-md">
                    <label text="üèÜ ÂìÅÁ±ªÈîÄÂîÆÊéíË°å" type="h6" style="q-mb-md"/>
                    <if condition="categorySales">
                        <section-iterate list="categorySales" entry="cs">
                            <widgets>
                                <container style="q-py-sm border-bottom">
                                    <label text="${cs.categoryName}" style="font-weight: 500; display: block;"/>
                                    <label text="${cs.totalAmount ? ec.l10n.formatCurrency(cs.totalAmount, 'CNY') : '‚Äî'} / Êï∞Èáè ${cs.quantity ?: 0}" style="color: #666; font-size: 12px;"/>
                                </container>
                            </widgets>
                        </section-iterate>
                    </if>
                    <if condition="!categorySales">
                        <container style="text-center q-pa-md text-grey-6">
                            <label text="ÊöÇÊó†ÈîÄÂîÆÊï∞ÊçÆ"/>
                        </container>
                    </if>
                </container>
            </container>

            <!-- ÊèêÈÜíÂíåÂÆ¢Êà∑ÂàÜÊûêÂå∫Âüü -->
            <container style="row q-gutter-md q-mb-md">
                <container style="col-6 q-card q-pa-md">
                    <label text="‚ö†Ô∏è ‰ΩéÂ∫ìÂ≠òÊèêÈÜí" type="h6" style="q-mb-md"/>
                    <if condition="lowStockProducts">
                        <section-iterate list="lowStockProducts" entry="product">
                            <widgets>
                                <container style="q-py-sm border-bottom bg-orange-1 q-pa-sm q-mb-sm rounded-borders">
                                    <label text="${product.productName ?: product.ecommerceProductId}" style="font-weight: 500; display: block;"/>
                                    <label text="Â∫ìÂ≠ò ${product.stockQuantity ?: 0} ‰ª∂ ¬∑ ÂàÜÁ±ª ${productCategoryName[product.productCategoryId] ?: '‚Äî'}" style="color: #e65100; font-size: 12px;"/>
                                </container>
                            </widgets>
                        </section-iterate>
                    </if>
                    <if condition="!lowStockProducts">
                        <container style="text-center q-pa-md text-green-6">
                            <label text="‚úÖ Êó†‰ΩéÂ∫ìÂ≠òÂïÜÂìÅ"/>
                        </container>
                    </if>
                </container>

                <container style="col-6 q-card q-pa-md">
                    <label text="üëë ‰∏ªË¶ÅÂÆ¢Êà∑" type="h6" style="q-mb-md"/>
                    <if condition="topCustomers">
                        <section-iterate list="topCustomers" entry="cust">
                            <widgets>
                                <container style="q-py-sm border-bottom">
                                    <label text="${cust.customerName ?: cust.ecommerceCustomerId}" style="font-weight: 500; display: block;"/>
                                    <label text="ËÆ¢Âçï ${cust.orderCount ?: 0} ¬∑ ÈáëÈ¢ù ${cust.totalAmount ? ec.l10n.formatCurrency(cust.totalAmount, 'CNY') : '‚Äî'}" style="color: #666; font-size: 12px;"/>
                                </container>
                            </widgets>
                        </section-iterate>
                    </if>
                    <if condition="!topCustomers">
                        <container style="text-center q-pa-md text-grey-6">
                            <label text="ÊöÇÊó†ÂÆ¢Êà∑ÁªüËÆ°"/>
                        </container>
                    </if>
                </container>
            </container>

            <!-- Telegram ËÅîÂä®ÊèêÁ§∫ -->
            <container style="q-card q-pa-md bg-blue-1">
                <label text="üì± Telegram ËÅîÂä®ÊèêÁ§∫" type="h6" style="q-mb-md text-blue-8"/>
                <container style="q-gutter-sm">
                    <container style="row items-center q-py-xs">
                        <label text="‚Ä¢" style="color: #1976d2; font-weight: bold; margin-right: 8px;"/>
                        <label text="ÂïÜÂìÅÂΩïÂÖ•Ôºö/product add name=Á§∫‰æã price=199 stock=50" style="color: #1976d2;"/>
                    </container>
                    <container style="row items-center q-py-xs">
                        <label text="‚Ä¢" style="color: #1976d2; font-weight: bold; margin-right: 8px;"/>
                        <label text="ËÆ¢ÂçïÂàõÂª∫Ôºö/order create customer=EC_CUST_001 items=ECP1001:1,ECP1004:2" style="color: #1976d2;"/>
                    </container>
                    <container style="row items-center q-py-xs">
                        <label text="‚Ä¢" style="color: #1976d2; font-weight: bold; margin-right: 8px;"/>
                        <label text="Êô∫ËÉΩÊé®ËçêÔºöÁÇπÂáªËèúÂçï&quot;üéØ Êô∫ËÉΩÊé®Ëçê&quot;ÊàñÁõ¥Êé•ËæìÂÖ•ÈúÄÊ±Ç" style="color: #1976d2;"/>
                    </container>
                    <container style="row items-center q-py-xs">
                        <label text="‚Ä¢" style="color: #1976d2; font-weight: bold; margin-right: 8px;"/>
                        <label text="È°πÁõÆË∑üËøõÔºöËΩ¨Ëá≥&quot;ËúÇÂ∑¢È°πÁõÆÁÆ°ÁêÜ&quot;Ê®°ÂùóÊàñ‰ΩøÁî® /project Êåá‰ª§" style="color: #1976d2;"/>
                    </container>
                </container>
            </container>
        </container>
    </widgets>
</screen>
