<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-3.xsd"
        default-menu-title="ÊµÅË°åÁîµÂïÜ"
        require-authentication="false">

    <actions>
        <script><![CDATA[
            import org.moqui.entity.EntityCondition
            import java.time.LocalDate
            import java.time.ZoneId
            import java.math.BigDecimal
            import java.math.RoundingMode

            productStats = [total: 0, active: 0, lowStock: 0, categories: 0]
            productCategoryName = [:]
            recentProducts = []
            lowStockProducts = []
            orderStats = [total: 0, open: 0, today: 0]
            statusSummary = [:]
            recentOrders = []
            openOrders = []
            categorySales = []
            topCustomers = []

            try {
                def categoryList = ec.entity.find("marketplace.ecommerce.EcommerceProductCategory")
                        .disableAuthz().list()
                categoryList?.each { cat ->
                    productCategoryName[cat.productCategoryId] = cat.categoryName ?: cat.productCategoryId
                }
            } catch (Exception e) {
                ec.logger.warn("Êó†Ê≥ïÂä†ËΩΩÁîµÂïÜÂàÜÁ±ª: ${e.message}")
            }

            try {
                def productList = ec.entity.find("marketplace.ecommerce.EcommerceProduct")
                        .disableAuthz().list()
                productStats.total = productList?.size() ?: 0
                productStats.active = productList?.count { "ACTIVE".equalsIgnoreCase(it.status ?: "") } ?: 0
                productStats.lowStock = productList?.count {
                    def qty = it.stockQuantity instanceof Number ? ((Number) it.stockQuantity).longValue() : 0L
                    qty < 10L
                } ?: 0
                Set categorySet = new LinkedHashSet(productList?.collect { it.productCategoryId }?.findAll { it })
                productStats.categories = categorySet?.size() ?: 0

                recentProducts = productList?.sort { a, b ->
                    def tsA = a.lastUpdatedDate ?: a.createdDate
                    def tsB = b.lastUpdatedDate ?: b.createdDate
                    (tsB?.time ?: 0) <=> (tsA?.time ?: 0)
                }?.take(6) ?: []

                lowStockProducts = productList?.findAll {
                    def qty = it.stockQuantity instanceof Number ? ((Number) it.stockQuantity).longValue() : 0L
                    qty in 0..<10
                }?.sort { it.stockQuantity ?: 0 }?.take(5) ?: []
            } catch (Exception e) {
                ec.logger.warn("Âä†ËΩΩÂïÜÂìÅÁªüËÆ°Â§±Ë¥•: ${e.message}")
            }

            try {
                def orderFind = ec.entity.find("marketplace.ecommerce.EcommerceOrder")
                        .orderBy("-createdDate")
                        .limit(20)
                        .disableAuthz()
                def orders = orderFind.list()
                orderStats.total = ec.entity.find("marketplace.ecommerce.EcommerceOrder").disableAuthz().count() ?: 0
                statusSummary = orders?.groupBy { it.orderStatus ?: "UNKNOWN" }?.collectEntries { k, v -> [(k): v.size()] } ?: [:]

                def openStatuses = ["CREATED","PAID","PROCESSING"]
                orderStats.open = ec.entity.find("marketplace.ecommerce.EcommerceOrder")
                        .condition("orderStatus", EntityCondition.IN, openStatuses)
                        .disableAuthz()
                        .count() ?: 0

                LocalDate today = LocalDate.now(ZoneId.systemDefault())
                long startOfDay = today.atStartOfDay(ZoneId.systemDefault()).toInstant().toEpochMilli()
                orderStats.today = orders?.count { it.createdDate && it.createdDate.time >= startOfDay } ?: 0

                recentOrders = orders?.take(6) ?: []
                openOrders = orders?.findAll { (it.orderStatus ?: "") in openStatuses }?.take(5) ?: []
            } catch (Exception e) {
                ec.logger.warn("Âä†ËΩΩËÆ¢ÂçïÁªüËÆ°Â§±Ë¥•: ${e.message}")
            }

            try {
                def itemList = ec.entity.find("marketplace.ecommerce.EcommerceOrderItem").disableAuthz().list()
                Map<String, Map> productCache = [:]
                Map<String, Map> categoryAgg = [:]
                itemList?.each { itemVal ->
                    String productId = itemVal.ecommerceProductId
                    if (!productId) return
                    Map prod = productCache[productId]
                    if (!prod) {
                        prod = ec.entity.find("marketplace.ecommerce.EcommerceProduct")
                                .condition("ecommerceProductId", productId)
                                .disableAuthz().one()?.getMap(false)
                        productCache[productId] = prod
                    }
                    String categoryId = prod?.productCategoryId ?: "UNSPECIFIED"
                    BigDecimal itemTotal = itemVal.itemTotal instanceof BigDecimal ?
                            (BigDecimal) itemVal.itemTotal :
                            (itemVal.itemTotal ? new BigDecimal(itemVal.itemTotal.toString()) : BigDecimal.ZERO)
                    Map agg = categoryAgg[categoryId] ?: [total: BigDecimal.ZERO, quantity: 0L]
                    agg.total = agg.total.add(itemTotal ?: BigDecimal.ZERO)
                    Long qty = itemVal.quantity instanceof Number ? ((Number) itemVal.quantity).longValue() : 0L
                    agg.quantity = agg.quantity + qty
                    categoryAgg[categoryId] = agg
                }
                categorySales = categoryAgg.collect { cid, agg ->
                    [
                        categoryId  : cid,
                        categoryName: productCategoryName[cid] ?: (cid == "UNSPECIFIED" ? "Êú™ÂàÜÁ±ª" : cid),
                        totalAmount : agg.total,
                        quantity    : agg.quantity
                    ]
                }.sort { a, b -> (b.totalAmount ?: BigDecimal.ZERO) <=> (a.totalAmount ?: BigDecimal.ZERO) }.take(6)
            } catch (Exception e) {
                ec.logger.warn("ÁªüËÆ°ÂìÅÁ±ªÈîÄÂîÆÂ§±Ë¥•: ${e.message}")
            }

            try {
                def orders = ec.entity.find("marketplace.ecommerce.EcommerceOrder").disableAuthz().list()
                Map<String, Map> customerAgg = [:]
                orders?.each { orderVal ->
                    String customerId = orderVal.ecommerceCustomerId ?: "UNASSIGNED"
                    Map agg = customerAgg[customerId] ?: [orders: 0, amount: BigDecimal.ZERO]
                    agg.orders = agg.orders + 1
                    BigDecimal orderTotal = orderVal.orderTotal instanceof BigDecimal ?
                            (BigDecimal) orderVal.orderTotal :
                            (orderVal.orderTotal ? new BigDecimal(orderVal.orderTotal.toString()) : BigDecimal.ZERO)
                    agg.amount = agg.amount.add(orderTotal ?: BigDecimal.ZERO)
                    customerAgg[customerId] = agg
                }
                topCustomers = customerAgg.collect { cid, agg ->
                    [
                        ecommerceCustomerId: cid,
                        customerName       : cid,
                        orderCount         : agg.orders,
                        totalAmount        : agg.amount
                    ]
                }.sort { a, b -> (b.totalAmount ?: BigDecimal.ZERO) <=> (a.totalAmount ?: BigDecimal.ZERO) }.take(5)

                // Â°´ÂÖÖÂÆ¢Êà∑ÂêçÁß∞
                topCustomers.each { Map cust ->
                    if (cust.ecommerceCustomerId && cust.ecommerceCustomerId != "UNASSIGNED") {
                        def customerValue = ec.entity.find("marketplace.ecommerce.EcommerceCustomer")
                                .condition("ecommerceCustomerId", cust.ecommerceCustomerId)
                                .disableAuthz().one()
                        if (customerValue) {
                            cust.customerName = customerValue.fullName ?: customerValue.ecommerceCustomerId
                        }
                    }
                }
            } catch (Exception e) {
                ec.logger.warn("ÁªüËÆ°ÂÆ¢Êà∑‰ø°ÊÅØÂ§±Ë¥•: ${e.message}")
            }
        ]]></script>
    </actions>

    <widgets>
        <container style="padding:16px;">
            <label text="ÊµÅË°åÁîµÂïÜÊéßÂà∂Âè∞" style="font-size:1.5rem;font-weight:600;margin-bottom:16px;display:block"/>
            <label text="Âü∫‰∫é Telegram ÁöÑÂïÜÂìÅ„ÄÅÂ∫ìÂ≠ò‰∏éËÆ¢ÂçïÂçèÂêå‰∏≠ÂøÉ" style="color:#616161;margin-bottom:24px;display:block"/>

        <container-row>
            <row-col lg="3" md="6" sm="12">
                <container style="text-align:center;margin-bottom:16px;border:1px solid #e0e0e0;border-radius:6px;padding:16px;">
                    <label text="ÂïÜÂìÅÊÄªÊï∞" style="font-size:1rem;color:#616161"/>
                    <label text="${productStats.total ?: 0}" style="font-size:2rem;font-weight:bold;color:#2196f3;margin:8px 0"/>
                    <label text="Ê¥ªË∑É ${productStats.active ?: 0}" style="font-size:0.9rem;color:#9e9e9e"/>
                </container>
            </row-col>
            <row-col lg="3" md="6" sm="12">
                <container style="text-align:center;margin-bottom:16px;border:1px solid #e0e0e0;border-radius:6px;padding:16px;">
                    <label text="‰ΩéÂ∫ìÂ≠ò" style="font-size:1rem;color:#f57c00"/>
                    <label text="${productStats.lowStock ?: 0}" style="font-size:2rem;font-weight:bold;color:#f57c00;margin:8px 0"/>
                    <label text="ÈòàÂÄº &lt; 10" style="font-size:0.9rem;color:#9e9e9e"/>
                </container>
            </row-col>
            <row-col lg="3" md="6" sm="12">
                <container style="text-align:center;margin-bottom:16px;border:1px solid #e0e0e0;border-radius:6px;padding:16px;">
                    <label text="ÂæÖÂ§ÑÁêÜËÆ¢Âçï" style="font-size:1rem;color:#009688"/>
                    <label text="${orderStats.open ?: 0}" style="font-size:2rem;font-weight:bold;color:#009688;margin:8px 0"/>
                    <label text="‰ªäÊó•Êñ∞Âª∫ ${orderStats.today ?: 0}" style="font-size:0.9rem;color:#9e9e9e"/>
                </container>
            </row-col>
            <row-col lg="3" md="6" sm="12">
                <container style="text-align:center;margin-bottom:16px;border:1px solid #e0e0e0;border-radius:6px;padding:16px;">
                    <label text="ÂìÅÁ±ªË¶ÜÁõñ" style="font-size:1rem;color:#7b1fa2"/>
                    <label text="${productStats.categories ?: 0}" style="font-size:2rem;font-weight:bold;color:#7b1fa2;margin:8px 0"/>
                    <label text="Telegram ËèúÂçïÂÆûÊó∂ÂêåÊ≠•" style="font-size:0.9rem;color:#9e9e9e"/>
                </container>
            </row-col>
        </container-row>

        <container-row>
            <row-col lg="12">
                <container style="border:1px solid #e0e0e0;border-radius:6px;padding:16px;margin-bottom:16px;">
                    <label text="Â∏∏Áî®Êìç‰Ωú" style="font-size:1.1rem;font-weight:500;display:block;margin-bottom:12px"/>
                    <container style="display:flex;flex-wrap:wrap;gap:12px;">
                        <link text="‚ûï Telegram /product add" url="#" link-type="anchor"
                              style="padding:8px 12px;border:1px solid #2196f3;border-radius:4px;color:#2196f3;"
                              transition="false"/>
                        <link text="üõí Telegram /order create" url="#" link-type="anchor"
                              style="padding:8px 12px;border:1px solid #009688;border-radius:4px;color:#009688;"
                              transition="false"/>
                        <link text="üìä Êü•ÁúãÂåπÈÖç Dashboard" url="../Dashboard" link-type="anchor"
                              style="padding:8px 12px;border:1px solid #795548;border-radius:4px;color:#795548;"/>
                        <link text="‚öôÔ∏è ÁîµÂïÜÈÖçÁΩÆ (SystemConfig)" url="../SystemConfig" link-type="anchor"
                              style="padding:8px 12px;border:1px solid #546e7a;border-radius:4px;color:#546e7a;"/>
                        <label text="ÊèêÁ§∫ÔºöÊåá‰ª§ÂùáÂú® Telegram Bot ‰∏≠ÊâßË°åÔºåWeb ÊéßÂà∂Âè∞‰ªÖÁî®‰∫éÁõëÊéß‰∏éÊ†°È™å„ÄÇ" style="color:#757575;padding:8px 0;"/>
                    </container>
                </container>
            </row-col>
        </container-row>

        <container-row>
            <row-col lg="6" md="12">
                <container style="border:1px solid #e0e0e0;border-radius:6px;padding:16px;margin-bottom:16px;">
                    <label text="ÊúÄÊñ∞ÂïÜÂìÅ" style="font-size:1.1rem;font-weight:500"/>
                    <if condition="recentProducts">
                        <container style="table table-striped margin-top">
                            <container style="thead">
                                <container style="tr">
                                    <container style="th"><label text="ÂêçÁß∞"/></container>
                                    <container style="th"><label text="ÂàÜÁ±ª"/></container>
                                    <container style="th"><label text="‰ª∑Ê†º"/></container>
                                    <container style="th"><label text="Â∫ìÂ≠ò"/></container>
                                </container>
                            </container>
                            <container style="tbody">
                                <section-iterate list="recentProducts" entry="product">
                                    <widgets>
                                        <container style="tr">
                                            <container style="td"><label text="${product.productName ?: product.ecommerceProductId}"/></container>
                                            <container style="td"><label text="${productCategoryName[product.productCategoryId] ?: product.productCategoryId ?: '‚Äî'}"/></container>
                                            <container style="td"><label text="${product.price ? ec.l10n.formatCurrency(product.price, product.currencyUomId ?: 'CNY') : '‚Äî'}"/></container>
                                            <container style="td"><label text="${product.stockQuantity ?: 0}"/></container>
                                        </container>
                                    </widgets>
                                </section-iterate>
                            </container>
                        </container>
                    </if>
                    <if condition="!recentProducts">
                        <label text="ÊöÇÊó†ÂïÜÂìÅËÆ∞ÂΩï" style="color:#9e9e9e;display:block;margin-top:8px"/>
                    </if>
                </container>
            </row-col>
            <row-col lg="6" md="12">
                <container style="border:1px solid #e0e0e0;border-radius:6px;padding:16px;margin-bottom:16px;">
                    <label text="ÊúÄÊñ∞ËÆ¢Âçï" style="font-size:1.1rem;font-weight:500"/>
                    <if condition="recentOrders">
                        <container style="table table-striped margin-top">
                            <container style="thead">
                                <container style="tr">
                                    <container style="th"><label text="ËÆ¢Âçï"/></container>
                                    <container style="th"><label text="Áä∂ÊÄÅ"/></container>
                                    <container style="th"><label text="ÈáëÈ¢ù"/></container>
                                    <container style="th"><label text="ÂÆ¢Êà∑"/></container>
                                </container>
                            </container>
                            <container style="tbody">
                                <section-iterate list="recentOrders" entry="order">
                                    <widgets>
                                        <container style="tr">
                                            <container style="td"><label text="${order.ecommerceOrderId}"/></container>
                                            <container style="td"><label text="${order.orderStatus ?: '‚Äî'}"/></container>
                                            <container style="td"><label text="${order.orderTotal ? ec.l10n.formatCurrency(order.orderTotal, order.currencyUomId ?: 'CNY') : '‚Äî'}"/></container>
                                            <container style="td"><label text="${order.ecommerceCustomerId ?: '‚Äî'}"/></container>
                                        </container>
                                    </widgets>
                                </section-iterate>
                            </container>
                        </container>
                    </if>
                    <if condition="!recentOrders">
                        <label text="ÊöÇÊó†ËÆ¢ÂçïËÆ∞ÂΩï" style="color:#9e9e9e;display:block;margin-top:8px"/>
                    </if>
                </container>
            </row-col>
        </container-row>

        <container-row>
            <row-col lg="6" md="12">
                <container style="border:1px solid #e0e0e0;border-radius:6px;padding:16px;margin-bottom:16px;">
                    <label text="ËÆ¢ÂçïÁä∂ÊÄÅÂàÜÂ∏É" style="font-size:1.1rem;font-weight:500"/>
                    <if condition="statusSummary">
                        <section-iterate list="statusSummary.entrySet()" entry="entry">
                            <widgets>
                                <container style="display:flex;justify-content:space-between;border-bottom:1px solid #f0f0f0;padding:6px 0;">
                                    <label text="${entry.key}" style="font-weight:500"/>
                                    <label text="${entry.value}" style="color:#616161"/>
                                </container>
                            </widgets>
                        </section-iterate>
                    </if>
                    <if condition="!statusSummary || statusSummary.isEmpty()">
                        <label text="ÊöÇÊó†Áä∂ÊÄÅÊï∞ÊçÆ" style="color:#9e9e9e;display:block;margin-top:8px"/>
                    </if>
                </container>
            </row-col>
            <row-col lg="6" md="12">
                <container style="border:1px solid #e0e0e0;border-radius:6px;padding:16px;margin-bottom:16px;">
                    <label text="ÂìÅÁ±ªÈîÄÂîÆÊéíË°å" style="font-size:1.1rem;font-weight:500"/>
                    <if condition="categorySales">
                        <section-iterate list="categorySales" entry="cs">
                            <widgets>
                                <container style="padding:6px 0;border-bottom:1px solid #f0f0f0;">
                                    <label text="${cs.categoryName}" style="font-weight:500"/>
                                    <label text="${cs.totalAmount ? ec.l10n.formatCurrency(cs.totalAmount, 'CNY') : '‚Äî'} / Êï∞Èáè ${cs.quantity ?: 0}"
                                           style="display:block;color:#616161"/>
                                </container>
                            </widgets>
                        </section-iterate>
                    </if>
                    <if condition="!categorySales">
                        <label text="ÊöÇÊó†ÈîÄÂîÆÊï∞ÊçÆ" style="color:#9e9e9e;display:block;margin-top:8px"/>
                    </if>
                </container>
            </row-col>
        </container-row>

        <container-row>
            <row-col lg="6" md="12">
                <container style="border:1px solid #e0e0e0;border-radius:6px;padding:16px;margin-bottom:16px;">
                    <label text="‰ΩéÂ∫ìÂ≠òÊèêÈÜí" style="font-size:1.1rem;font-weight:500"/>
                    <if condition="lowStockProducts">
                        <section-iterate list="lowStockProducts" entry="product">
                            <widgets>
                                <container style="padding:6px 0;border-bottom:1px solid #f0f0f0;">
                                    <label text="${product.productName ?: product.ecommerceProductId}" style="font-weight:500"/>
                                    <label text="Â∫ìÂ≠ò ${product.stockQuantity ?: 0} ‰ª∂ ¬∑ ÂàÜÁ±ª ${productCategoryName[product.productCategoryId] ?: '‚Äî'}"
                                           style="display:block;color:#616161"/>
                                </container>
                            </widgets>
                        </section-iterate>
                    </if>
                    <if condition="!lowStockProducts">
                        <label text="ÊöÇÊó†‰ΩéÂ∫ìÂ≠òÂïÜÂìÅ" style="color:#9e9e9e;display:block;margin-top:8px"/>
                    </if>
                </container>
            </row-col>
            <row-col lg="6" md="12">
                <container style="border:1px solid #e0e0e0;border-radius:6px;padding:16px;margin-bottom:16px;">
                    <label text="‰∏ªË¶ÅÂÆ¢Êà∑" style="font-size:1.1rem;font-weight:500"/>
                    <if condition="topCustomers">
                        <section-iterate list="topCustomers" entry="cust">
                            <widgets>
                                <container style="padding:6px 0;border-bottom:1px solid #f0f0f0;">
                                    <label text="${cust.customerName ?: cust.ecommerceCustomerId}" style="font-weight:500"/>
                                    <label text="ËÆ¢Âçï ${cust.orderCount ?: 0} ¬∑ ÈáëÈ¢ù ${cust.totalAmount ? ec.l10n.formatCurrency(cust.totalAmount, 'CNY') : '‚Äî'}"
                                           style="display:block;color:#616161"/>
                                </container>
                            </widgets>
                        </section-iterate>
                    </if>
                    <if condition="!topCustomers">
                        <label text="ÊöÇÊó†ÂÆ¢Êà∑ÁªüËÆ°" style="color:#9e9e9e;display:block;margin-top:8px"/>
                    </if>
                </container>
            </row-col>
        </container-row>

        <container style="border:1px dashed #bdbdbd;border-radius:6px;padding:16px;background:#fafafa;">
            <label text="Telegram ËÅîÂä®ÊèêÁ§∫" style="font-weight:500;margin-bottom:8px;display:block"/>
            <label text="‚Ä¢ ÂïÜÂìÅÂΩïÂÖ•Ôºö/product add name=Á§∫‰æã‰ª∑Ê†º=199 stock=50" style="display:block;color:#616161"/>
            <label text="‚Ä¢ ËÆ¢ÂçïÂàõÂª∫Ôºö/order create customer=EC_CUST_001 items=ECP1001:1,ECP1004:2" style="display:block;color:#616161"/>
            <label text="‚Ä¢ Êô∫ËÉΩÊé®ËçêÔºöÁÇπÂáªËèúÂçï‚ÄúüéØ Êô∫ËÉΩÊé®Ëçê‚ÄùÊàñÁõ¥Êé•ËæìÂÖ•ÈúÄÊ±Ç" style="display:block;color:#616161"/>
            <label text="‚Ä¢ Ëã•Ë¶ÅË∑üËøõÈ°πÁõÆÊâßË°åÔºåËØ∑ËΩ¨Ëá≥‚ÄúËúÇÂ∑¢È°πÁõÆÁÆ°ÁêÜ‚ÄùÊ®°ÂùóÊàñ‰ΩøÁî® /project Êåá‰ª§" style="display:block;color:#616161"/>
        </container>

        </container>
    </widgets>
</screen>
