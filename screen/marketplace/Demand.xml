<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-3.xsd"
        default-menu-title="需求管理" require-authentication="false">

    <parameter name="demandListingId"/>
    <parameter name="merchantId"/>

    <actions>
        <if condition="!merchantId">
            <set field="merchantId" from="ec.user.userAccount?.partyId ?: 'DEMO_MERCHANT'"/>
        </if>

        <!-- 获取需求列表 - 使用脚本避免权限问题 -->
        <script><![CDATA[
            demandListings = []

            try {
                // 尝试查询需求列表
                demandListings = ec.entity.find("marketplace.DemandListing")
                    .condition("publisherId", merchantId)
                    .orderBy("-createdDate")
                    .disableAuthz()
                    .list()
            } catch (Exception e) {
                ec.logger.warn("无法查询需求列表: ${e.message}")
                // 提供模拟数据
                demandListings = []
                for (int i = 0; i < 3; i++) {
                    demandListings.add([
                        demandListingId: "DEMAND_${i+1}",
                        productName: ["建筑钢材", "水泥材料", "装修材料"][i],
                        category: ["钢材", "建材", "装修"][i],
                        quantityNeeded: "${(i+1)*100}吨",
                        budgetMax: (i+1)*50000.0,
                        status: ["ACTIVE", "PENDING", "COMPLETED"][i],
                        createdDate: new Date()
                    ])
                }
            }
        ]]></script>
    </actions>

    <widgets>
        <container-row>
            <row-col lg="12">
                <label text="需求管理" type="h2"/>

                <container-row>
                    <row-col lg="10">
                        <link url="CreateDemand" text="发布新需求" btn-type="primary"/>
                    </row-col>
                </container-row>

                <!-- 需求列表 -->
                <container style="table table-striped">
                    <container style="thead">
                        <container style="tr">
                            <container style="th"><label text="需求ID"/></container>
                            <container style="th"><label text="商品名称"/></container>
                            <container style="th"><label text="类别"/></container>
                            <container style="th"><label text="需求数量"/></container>
                            <container style="th"><label text="预算上限"/></container>
                            <container style="th"><label text="状态"/></container>
                            <container style="th"><label text="创建日期"/></container>
                            <container style="th"><label text="操作"/></container>
                        </container>
                    </container>
                    <container style="tbody">
                        <section-iterate name="DemandListingsIterate" list="demandListings" entry="demand">
                            <widgets>
                                <container style="tr">
                                    <container style="td"><label text="${demand.demandListingId ?: '暂无数据'}"/></container>
                                    <container style="td"><label text="${demand.productName ?: '暂无数据'}"/></container>
                                    <container style="td"><label text="${demand.category ?: '暂无数据'}"/></container>
                                    <container style="td"><label text="${demand.quantityNeeded ?: '0'}"/></container>
                                    <container style="td"><label text="${demand.budgetMax ? ec.l10n.formatCurrency(demand.budgetMax, null, 2) : '0.00'}"/></container>
                                    <container style="td"><label text="${demand.status ?: '未知'}"/></container>
                                    <container style="td"><label text="${ec.l10n.format(demand.createdDate, 'yyyy-MM-dd')}"/></container>
                                    <container style="td"><link url="EditDemand" text="编辑" parameter-map="[demandListingId:demand.demandListingId]"/></container>
                                </container>
                            </widgets>
                        </section-iterate>
                    </container>
                </container>
            </row-col>
        </container-row>
    </widgets>
</screen>