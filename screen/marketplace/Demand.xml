<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-3.xsd"
        default-menu-title="éœ€æ±‚ç®¡ç†" require-authentication="false">

    <parameter name="demandListingId"/>
    <parameter name="merchantId"/>

    <actions>
        <if condition="!merchantId">
            <set field="merchantId" from="ec.user.userAccount?.partyId ?: 'DEMO_MERCHANT'"/>
        </if>

        <!-- èŽ·å–éœ€æ±‚åˆ—è¡¨ - ä½¿ç”¨è„šæœ¬é¿å…æƒé™é—®é¢˜ -->
        <script><![CDATA[
            demandListings = []

            try {
                // å°è¯•æŸ¥è¯¢éœ€æ±‚åˆ—è¡¨
                demandListings = ec.entity.find("marketplace.DemandListing")
                    .condition("publisherId", merchantId)
                    .orderBy("-createdDate")
                    .disableAuthz()
                    .list()
            } catch (Exception e) {
                ec.logger.warn("æ— æ³•æŸ¥è¯¢éœ€æ±‚åˆ—è¡¨: ${e.message}")
                // æä¾›æ¨¡æ‹Ÿæ•°æ®
                demandListings = []
                for (int i = 0; i < 3; i++) {
                    demandListings.add([
                        demandListingId: "DEMAND_${i+1}",
                        productName: ["å»ºç­‘é’¢æ", "æ°´æ³¥ææ–™", "è£…ä¿®ææ–™"][i],
                        category: ["é’¢æ", "å»ºæ", "è£…ä¿®"][i],
                        quantityNeeded: "${(i+1)*100}å¨",
                        budgetMax: (i+1)*50000.0,
                        status: ["ACTIVE", "PENDING", "COMPLETED"][i],
                        createdDate: new Date()
                    ])
                }
            }
        ]]></script>
    </actions>

    <widgets>
        <container-row>
            <row-col lg="12">
                <label text="ðŸ›’ éœ€æ±‚ç®¡ç†" type="h5" style="q-mb-md"/>

                <container-row>
                    <row-col lg="10">
                        <link url="CreateDemand" text="å‘å¸ƒæ–°éœ€æ±‚" btn-type="primary"/>
                    </row-col>
                </container-row>

                <!-- éœ€æ±‚åˆ—è¡¨ -->
                <container style="table table-striped">
                    <container style="thead">
                        <container style="tr">
                            <container style="th"><label text="éœ€æ±‚ID"/></container>
                            <container style="th"><label text="å•†å“åç§°"/></container>
                            <container style="th"><label text="ç±»åˆ«"/></container>
                            <container style="th"><label text="éœ€æ±‚æ•°é‡"/></container>
                            <container style="th"><label text="é¢„ç®—ä¸Šé™"/></container>
                            <container style="th"><label text="çŠ¶æ€"/></container>
                            <container style="th"><label text="åˆ›å»ºæ—¥æœŸ"/></container>
                            <container style="th"><label text="æ“ä½œ"/></container>
                        </container>
                    </container>
                    <container style="tbody">
                        <section-iterate name="DemandListingsIterate" list="demandListings" entry="demand">
                            <widgets>
                                <container style="tr">
                                    <container style="td"><label text="${demand.demandListingId ?: 'æš‚æ— æ•°æ®'}"/></container>
                                    <container style="td"><label text="${demand.productName ?: 'æš‚æ— æ•°æ®'}"/></container>
                                    <container style="td"><label text="${demand.category ?: 'æš‚æ— æ•°æ®'}"/></container>
                                    <container style="td"><label text="${demand.quantityNeeded ?: '0'}"/></container>
                                    <container style="td"><label text="${demand.budgetMax ? ec.l10n.formatCurrency(demand.budgetMax, null, 2) : '0.00'}"/></container>
                                    <container style="td"><label text="${demand.status ?: 'æœªçŸ¥'}"/></container>
                                    <container style="td"><label text="${ec.l10n.format(demand.createdDate, 'yyyy-MM-dd')}"/></container>
                                    <container style="td"><link url="EditDemand" text="ç¼–è¾‘" parameter-map="[demandListingId:demand.demandListingId]"/></container>
                                </container>
                            </widgets>
                        </section-iterate>
                    </container>
                </container>
            </row-col>
        </container-row>
    </widgets>
</screen>