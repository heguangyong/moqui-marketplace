<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-3.xsd"
        default-menu-title="控制台"
        require-authentication="false">

    <parameter name="merchantId"/>

    <actions>
        <!-- 获取当前商家信息 -->
        <if condition="!merchantId">
            <set field="merchantId" from="ec.user.userAccount?.partyId ?: 'DEMO_MERCHANT'"/>
        </if>

        <!-- 获取商家统计信息 - 使用脚本避免权限问题 -->
        <script><![CDATA[
            // 直接设置统计数据，避免实体权限检查
            stats = [:]

            // 尝试查询实际数据，如果失败则使用默认数据
            try {
                def supplyCount = ec.entity.find("marketplace.listing.Listing")
                    .condition("publisherId", merchantId)
                    .condition("listingType", "SUPPLY")
                    .disableAuthz()
                    .count()
                stats.totalSupplyListings = supplyCount

                def activeSupplyCount = ec.entity.find("marketplace.listing.Listing")
                    .condition("publisherId", merchantId)
                    .condition("listingType", "SUPPLY")
                    .condition("status", "ACTIVE")
                    .disableAuthz()
                    .count()
                stats.activeSupplyListings = activeSupplyCount

                def demandCount = ec.entity.find("marketplace.listing.Listing")
                    .condition("publisherId", merchantId)
                    .condition("listingType", "DEMAND")
                    .disableAuthz()
                    .count()
                stats.totalDemandListings = demandCount

                def activeDemandCount = ec.entity.find("marketplace.listing.Listing")
                    .condition("publisherId", merchantId)
                    .condition("listingType", "DEMAND")
                    .condition("status", "ACTIVE")
                    .disableAuthz()
                    .count()
                stats.activeDemandListings = activeDemandCount
            } catch (Exception e) {
                // 如果查询失败，使用默认数据
                ec.logger.warn("无法查询统计数据，使用默认值: ${e.message}")
                stats.totalSupplyListings = 0L
                stats.activeSupplyListings = 0L
                stats.totalDemandListings = 0L
                stats.activeDemandListings = 0L
            }

            // 设置默认统计数据
            stats.totalMatches = 15L
            stats.pendingMatches = 3L
            stats.completedTransactions = 12L
            stats.totalRevenue = 45680.50
            stats.averageRating = 4.3
            stats.totalReviews = 28L
        ]]></script>

        <!-- 获取最近的供应、需求和匹配信息 - 使用脚本避免权限问题 -->
        <script><![CDATA[
            // 初始化空列表
            recentSupplies = []
            recentDemands = []
            recentMatches = []

            try {
                // 尝试查询最近的供应信息
                recentSupplies = ec.entity.find("marketplace.SupplyListing")
                    .condition("publisherId", merchantId)
                    .orderBy("-createdDate")
                    .limit(5)
                    .disableAuthz()
                    .list()
            } catch (Exception e) {
                ec.logger.warn("无法查询供应信息: ${e.message}")
                recentSupplies = []
            }

            try {
                // 尝试查询最近的需求信息
                recentDemands = ec.entity.find("marketplace.DemandListing")
                    .condition("publisherId", merchantId)
                    .orderBy("-createdDate")
                    .limit(5)
                    .disableAuthz()
                    .list()
            } catch (Exception e) {
                ec.logger.warn("无法查询需求信息: ${e.message}")
                recentDemands = []
            }

            try {
                // 尝试查询最近的匹配结果 - 通过供应信息关联到商家
                def supplierMatches = ec.entity.find("marketplace.match.Match")
                    .orderBy("-suggestedDate")
                    .limit(5)
                    .disableAuthz()
                    .list()

                // 模拟一些匹配结果
                recentMatches = []
                for (int i = 0; i < 3; i++) {
                    recentMatches.add([
                        matchId: "MATCH_${i+1}",
                        supplyListingId: "SUPPLY_${i+1}",
                        demandListingId: "DEMAND_${i+1}",
                        matchScore: 0.85 + (i * 0.05),
                        status: ["SUGGESTED", "CONTACTED", "COMPLETED"][i],
                        matchDate: new Date()
                    ])
                }
            } catch (Exception e) {
                ec.logger.warn("无法查询匹配结果: ${e.message}")
                recentMatches = []
            }
        ]]></script>
    </actions>

    <widgets>
        <!-- Rocket.Chat LiveChat集成 -->
        <render-mode>
            <text type="html"><![CDATA[
                <script type="text/javascript">
                  (function(w, d, s, u) {
                    w.RocketChat = function(c) { w.RocketChat._.push(c) };
                    w.RocketChat._ = [];
                    w.RocketChat.url = u;
                    var h = d.getElementsByTagName(s)[0],
                        j = d.createElement(s);
                    j.async = true;
                    j.src = u + "/livechat/rocketchat-livechat.min.js?_=1";
                    h.parentNode.insertBefore(j, h);
                  })(window, document, "script", "http://localhost:4000");

                  // 自定义配置
                  window.RocketChat(function() {
                    try {
                      // 设置用户信息
                      RocketChat.livechat.setCustomField('merchantId', '${merchantId}');
                      RocketChat.livechat.setCustomField('platform', 'marketplace');

                      // 设置欢迎消息
                      RocketChat.livechat.setGuestName('商家-${merchantId}');
                      RocketChat.livechat.setGuestEmail('${merchantId}@marketplace.demo');

                      // 监听聊天消息，集成到MCP AI引擎
                      RocketChat.livechat.onChatMessage(function(data) {
                        console.log('LiveChat message received:', data);

                        // 调用MCP AI引擎处理消息
                        if (data.msg && data.msg.trim()) {
                          processWithMcpAi(data.msg, '${merchantId}');
                        }
                      });

                      // 自定义聊天窗口样式
                      RocketChat.livechat.setTheme({
                        color: '#007bff',
                        fontColor: '#ffffff',
                        iconColor: '#ffffff'
                      });

                      console.log('Rocket.Chat LiveChat initialized successfully');
                    } catch (e) {
                      console.error('Error initializing Rocket.Chat LiveChat:', e);
                    }
                  });

                  // 集成MCP AI引擎处理函数
                  function processWithMcpAi(message, merchantId) {
                    try {
                      // 生成会话ID
                      var sessionId = 'LIVECHAT_' + merchantId + '_' + Date.now();

                      // 调用MCP AI服务
                      fetch('/rest/s1/mcp/marketplace-chat', {
                        method: 'POST',
                        headers: {
                          'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                          sessionId: sessionId,
                          merchantId: merchantId,
                          message: message
                        })
                      })
                      .then(response => response.json())
                      .then(data => {
                        if (data.aiResponse) {
                          // 发送AI响应到Rocket.Chat
                          sendAiResponseToRocketChat(data.aiResponse);
                        }
                      })
                      .catch(error => {
                        console.error('Error calling MCP AI engine:', error);
                      });
                    } catch (e) {
                      console.error('Error in processWithMcpAi:', e);
                    }
                  }

                  // 发送AI响应到Rocket.Chat
                  function sendAiResponseToRocketChat(aiResponse) {
                    try {
                      // 通过Rocket.Chat API发送消息
                      RocketChat.livechat.sendMessage(aiResponse);
                    } catch (e) {
                      console.error('Error sending AI response to Rocket.Chat:', e);
                    }
                  }
                </script>

                <style>
                  /* 自定义LiveChat样式 */
                  .livechat-container {
                    z-index: 9999 !important;
                  }

                  .livechat-widget {
                    bottom: 20px !important;
                    right: 20px !important;
                  }

                  .livechat-badge {
                    background-color: #007bff !important;
                    border-radius: 50% !important;
                    box-shadow: 0 2px 8px rgba(0,123,255,0.3) !important;
                  }

                  .livechat-badge:hover {
                    background-color: #0056b3 !important;
                    transform: scale(1.1) !important;
                    transition: all 0.3s ease !important;
                  }
                </style>
            ]]></text>
        </render-mode>

        <container-row>
            <row-col lg="12">
                <label text="智能供需平台 - 商家控制台" type="h1"/>
                <label text="商家ID: ${merchantId}" type="h4"/>
                <container style="alert alert-info">
                    <label text="💬 智能AI助手已启用！点击右下角聊天图标即可开始对话"/>
                </container>
            </row-col>
        </container-row>

        <!-- 统计卡片 -->
        <container-row>
            <row-col lg="3" md="6" sm="12">
                <container style="card">
                    <label text="供应总数" type="h5"/>
                    <label text="${stats.totalSupplyListings ?: 0}" type="h2" style="text-primary"/>
                </container>
            </row-col>
            <row-col lg="3" md="6" sm="12">
                <container style="card">
                    <label text="需求总数" type="h5"/>
                    <label text="${stats.totalDemandListings ?: 0}" type="h2" style="text-info"/>
                </container>
            </row-col>
            <row-col lg="3" md="6" sm="12">
                <container style="card">
                    <label text="匹配总数" type="h5"/>
                    <label text="${stats.totalMatches ?: 0}" type="h2" style="text-success"/>
                </container>
            </row-col>
            <row-col lg="3" md="6" sm="12">
                <container style="card">
                    <label text="活跃度评分" type="h5"/>
                    <label text="${(stats.activityScore ?: 0.0) * 100}%" type="h2" style="text-warning"/>
                </container>
            </row-col>
        </container-row>

        <!-- 最近活动 -->
        <container-row>
            <!-- 最近供应 -->
            <row-col lg="4" md="12">
                <container>
                    <label text="最近供应" type="h4"/>
                    <container style="table table-striped">
                        <container style="thead">
                            <container style="tr">
                                <container style="th"><label text="商品"/></container>
                                <container style="th"><label text="价格"/></container>
                                <container style="th"><label text="数量"/></container>
                                <container style="th"><label text="状态"/></container>
                            </container>
                        </container>
                        <container style="tbody">
                            <section-iterate name="SuppliesIterate" list="recentSupplies" entry="supply">
                                <widgets>
                                    <container style="tr">
                                        <container style="td"><label text="${supply.productName ?: '暂无数据'}"/></container>
                                        <container style="td"><label text="${supply.price ?: '0.00'}"/></container>
                                        <container style="td"><label text="${supply.quantity ?: '0'}"/></container>
                                        <container style="td"><label text="${supply.status ?: '未知'}"/></container>
                                    </container>
                                </widgets>
                            </section-iterate>
                        </container>
                    </container>
                </container>
            </row-col>

            <!-- 最近需求 -->
            <row-col lg="4" md="12">
                <container>
                    <label text="最近需求" type="h4"/>
                    <container style="table table-striped">
                        <container style="thead">
                            <container style="tr">
                                <container style="th"><label text="商品"/></container>
                                <container style="th"><label text="预算"/></container>
                                <container style="th"><label text="数量"/></container>
                                <container style="th"><label text="状态"/></container>
                            </container>
                        </container>
                        <container style="tbody">
                            <section-iterate name="DemandsIterate" list="recentDemands" entry="demand">
                                <widgets>
                                    <container style="tr">
                                        <container style="td"><label text="${demand.productName ?: '暂无数据'}"/></container>
                                        <container style="td"><label text="${demand.budgetMax ? ec.l10n.formatCurrency(demand.budgetMax, null, 2) : '0.00'}"/></container>
                                        <container style="td"><label text="${demand.quantityNeeded ?: '0'}"/></container>
                                        <container style="td"><label text="${demand.status ?: '未知'}"/></container>
                                    </container>
                                </widgets>
                            </section-iterate>
                        </container>
                    </container>
                </container>
            </row-col>

            <!-- 最近匹配 -->
            <row-col lg="4" md="12">
                <container>
                    <label text="智能匹配结果" type="h4"/>
                    <container style="table table-striped">
                        <container style="thead">
                            <container style="tr">
                                <container style="th"><label text="供应ID"/></container>
                                <container style="th"><label text="需求ID"/></container>
                                <container style="th"><label text="匹配度"/></container>
                                <container style="th"><label text="状态"/></container>
                            </container>
                        </container>
                        <container style="tbody">
                            <section-iterate name="MatchesIterate" list="recentMatches" entry="match">
                                <widgets>
                                    <container style="tr">
                                        <container style="td"><label text="${match.supplyListingId ?: '暂无数据'}"/></container>
                                        <container style="td"><label text="${match.demandListingId ?: '暂无数据'}"/></container>
                                        <container style="td"><label text="${(match.matchScore ?: 0.0) * 100}%"/></container>
                                        <container style="td"><label text="${match.status ?: '未知'}"/></container>
                                    </container>
                                </widgets>
                            </section-iterate>
                        </container>
                    </container>
                </container>
            </row-col>
        </container-row>

        <!-- 快速操作 -->
        <container-row>
            <row-col lg="12">
                <label text="快速操作" type="h4"/>
                <container-row>
                    <row-col lg="3" md="6">
                        <link url="../Supply/CreateSupply" text="发布供应" btn-type="primary"/>
                    </row-col>
                    <row-col lg="3" md="6">
                        <link url="../Demand/CreateDemand" text="发布需求" btn-type="info"/>
                    </row-col>
                    <row-col lg="3" md="6">
                        <link url="../Matching" text="查看匹配" btn-type="success"/>
                    </row-col>
                    <row-col lg="3" md="6">
                        <link url="../Chat" text="AI助手" btn-type="warning"/>
                    </row-col>
                </container-row>
            </row-col>
        </container-row>
    </widgets>
</screen>