<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-3.xsd"
        default-menu-title="控制台"
        require-authentication="false">

    <parameter name="merchantId"/>

    <actions>
        <!-- 获取当前商家信息（默认展示全部） -->
        <if condition="!merchantId">
            <set field="merchantId" value="__ALL__"/>
        </if>

        <script><![CDATA[
            import org.moqui.entity.EntityCondition
            import java.sql.Timestamp
            import java.time.LocalDate
            import java.time.ZoneId
            import java.math.BigDecimal
            import java.math.RoundingMode

            def isAllMerchant = !merchantId || "__ALL__".equalsIgnoreCase(merchantId) || "ALL".equalsIgnoreCase(merchantId)
            displayMerchantName = isAllMerchant ? '全部商户' : merchantId
            filterMerchant = isAllMerchant ? '' : merchantId

            stats = [
                totalSupplyListings : 0L,
                activeSupplyListings: 0L,
                totalDemandListings : 0L,
                activeDemandListings: 0L,
                totalMatches        : 0L,
                completedTransactions: 0L
            ]
            matchingStats = [:]
            telegramStats = [
                totalSessions : 0L,
                activeSessions: 0L,
                todaySessions : 0L
            ]
            recentSupplies = []
            recentDemands = []
            recentMatchesDisplay = []
            telegramSessionsDisplay = []
            recentTelegramMessagesDisplay = []
            botUsername = System.getProperty("mcp.telegram.bot.username") ?: System.getProperty("telegram.bot.username") ?: "@待配置"

            def partyNameCache = [:]
            Closure<String> getPartyName = { String partyId ->
                if (!partyId) return ""
                if (partyNameCache.containsKey(partyId)) return partyNameCache[partyId]
                def detailFind = ec.entity.find("mantle.party.PartyDetail")
                detailFind.condition("partyId", partyId)
                detailFind.disableAuthz()
                def detail = detailFind.one()
                String name = detail?.fullName ?: detail?.organizationName ?: detail?.groupName ?: partyId
                partyNameCache[partyId] = name
                return name
            }

            Closure<Long> countListings = { String listingType, String status ->
                def find = ec.entity.find("marketplace.listing.Listing")
                    .condition("listingType", listingType)
                if (!isAllMerchant) find.condition("publisherId", merchantId)
                if (status) find.condition("status", status)
                find.disableAuthz()
                return (find.count() ?: 0L)
            }

            try {
                stats.totalSupplyListings = countListings("SUPPLY", null)
                stats.activeSupplyListings = countListings("SUPPLY", "ACTIVE")
                stats.totalDemandListings = countListings("DEMAND", null)
                stats.activeDemandListings = countListings("DEMAND", "ACTIVE")
            } catch (Exception e) {
                ec.logger.warn("统计供应/需求数量失败: ${e.message}")
            }

            try {
                def matchCountFind = ec.entity.find("marketplace.match.Match")
                if (!isAllMerchant) {
                    matchCountFind.condition("status", EntityCondition.ComparisonOperator.NOT_EQUAL, "REJECTED")
                }
                matchCountFind.disableAuthz()
                stats.totalMatches = matchCountFind.count() ?: 0L
            } catch (Exception e) {
                ec.logger.warn("统计匹配数量失败: ${e.message}")
            }

            try {
                Map matchStatsResp = ec.service.sync().name("marketplace.MarketplaceServices.get#MatchingStats")
                    .parameters(isAllMerchant ? [:] : [merchantId: merchantId])
                    .call()
                if (matchStatsResp) {
                    matchingStats = matchStatsResp
                    if (matchingStats.averageScore != null && !(matchingStats.averageScore instanceof BigDecimal)) {
                        matchingStats.averageScore = new BigDecimal(matchingStats.averageScore.toString())
                    }
                }
            } catch (Exception e) {
                ec.logger.warn("获取匹配统计失败: ${e.message}")
            }

            // 最近供应/需求
            try {
                def supplyFind = ec.entity.find("marketplace.SupplyListing")
                    .orderBy("-createdDate")
                    .limit(5)
                if (!isAllMerchant) supplyFind.condition("publisherId", merchantId)
                supplyFind.disableAuthz()
                recentSupplies = supplyFind.list()
            } catch (Exception e) {
                ec.logger.warn("无法查询供应信息: ${e.message}")
            }

            try {
                def demandFind = ec.entity.find("marketplace.DemandListing")
                    .orderBy("-createdDate")
                    .limit(5)
                if (!isAllMerchant) demandFind.condition("publisherId", merchantId)
                demandFind.disableAuthz()
                recentDemands = demandFind.list()
            } catch (Exception e) {
                ec.logger.warn("无法查询需求信息: ${e.message}")
            }

            // 列表缓存
            def listingCache = [:]
            Closure<Map> getListingInfo = { String listingId ->
                if (!listingId) return [title: "", publisherId: null]
                if (listingCache.containsKey(listingId)) return listingCache[listingId]
                def find = ec.entity.find("marketplace.listing.Listing")
                    .condition("listingId", listingId)
                find.disableAuthz()
                def listing = find.one()
                def info = [
                    title      : listing?.title ?: listingId,
                    publisherId: listing?.publisherId,
                    status     : listing?.status
                ]
                listingCache[listingId] = info
                return info
            }

            // 商家拥有的listing
            Set<String> merchantListingIds = new LinkedHashSet<>()
            if (!isAllMerchant) {
                def merchantListingFind = ec.entity.find("marketplace.listing.Listing")
                    .condition("publisherId", merchantId)
                merchantListingFind.disableAuthz()
                for (listing in merchantListingFind.list()) {
                    merchantListingIds.add(listing.listingId)
                }
            }

            try {
                def matchFind = ec.entity.find("marketplace.match.Match")
                    .orderBy("-suggestedDate")
                    .limit(20)
                matchFind.disableAuthz()
                def matchList = matchFind.list()
                for (matchValue in matchList) {
                    if (!matchValue) continue
                    boolean belongsToMerchant = isAllMerchant ||
                        merchantListingIds.contains(matchValue.supplyListingId) ||
                        merchantListingIds.contains(matchValue.demandListingId)
                    if (!belongsToMerchant) continue

                    BigDecimal matchScore = matchValue.matchScore ?: BigDecimal.ZERO
                    BigDecimal percent = matchScore.multiply(new BigDecimal("100")).setScale(1, RoundingMode.HALF_UP)
                    Map supplyInfo = getListingInfo(matchValue.supplyListingId)
                    Map demandInfo = getListingInfo(matchValue.demandListingId)

                    recentMatchesDisplay.add([
                            matchId           : matchValue.matchId,
                            matchScorePercent : percent,
                            status            : matchValue.status ?: "SUGGESTED",
                            suggestedDate     : matchValue.suggestedDate ?: matchValue.createdDate,
                            supplyTitle       : supplyInfo.title,
                            demandTitle       : demandInfo.title,
                            supplyListingId   : matchValue.supplyListingId,
                            demandListingId   : matchValue.demandListingId
                    ])
                }
                recentMatchesDisplay = recentMatchesDisplay.sort { it.suggestedDate ? -it.suggestedDate.time : 0 }.take(5)
            } catch (Exception e) {
                ec.logger.warn("无法查询匹配结果: ${e.message}")
            }

            // Telegram 会话统计
            try {
                EntityCondition telegramCondition = ec.entity.conditionFactory.makeCondition("sessionId", EntityCondition.ComparisonOperator.LIKE, "telegram%")
                def totalSessionsFind = ec.entity.find("mcp.dialog.McpDialogSession")
                    .condition(telegramCondition)
                    .condition("sessionType", "MARKETPLACE")
                if (!isAllMerchant) totalSessionsFind.condition("merchantId", merchantId)
                totalSessionsFind.disableAuthz()
                telegramStats.totalSessions = totalSessionsFind.count() ?: 0L

                def activeSessionsFind = ec.entity.find("mcp.dialog.McpDialogSession")
                    .condition(telegramCondition)
                    .condition("sessionType", "MARKETPLACE")
                    .condition("status", "ACTIVE")
                if (!isAllMerchant) activeSessionsFind.condition("merchantId", merchantId)
                activeSessionsFind.disableAuthz()
                telegramStats.activeSessions = activeSessionsFind.count() ?: 0L

                Timestamp startOfDay = Timestamp.valueOf(LocalDate.now(ZoneId.systemDefault()).atStartOfDay())
                def todaySessionsFind = ec.entity.find("mcp.dialog.McpDialogSession")
                    .condition(telegramCondition)
                    .condition("sessionType", "MARKETPLACE")
                    .condition("createdDate", EntityCondition.ComparisonOperator.GREATER_THAN_EQUAL_TO, startOfDay)
                if (!isAllMerchant) todaySessionsFind.condition("merchantId", merchantId)
                todaySessionsFind.disableAuthz()
                telegramStats.todaySessions = todaySessionsFind.count() ?: 0L

                def sessionListFind = ec.entity.find("mcp.dialog.McpDialogSession")
                    .condition(telegramCondition)
                    .condition("sessionType", "MARKETPLACE")
                    .orderBy("-lastModifiedDate")
                    .limit(5)
                if (!isAllMerchant) sessionListFind.condition("merchantId", merchantId)
                sessionListFind.disableAuthz()
                def sessionList = sessionListFind.list()

                def sessionById = [:]
                sessionList.each { sess ->
                    sessionById[sess.sessionId] = sess
                }

                // 最近的Telegram消息
                def messageFind = ec.entity.find("mcp.dialog.McpDialogMessage")
                    .condition("sessionId", EntityCondition.ComparisonOperator.LIKE, "telegram%")
                    .orderBy("-processedDate")
                    .limit(8)
                if (!isAllMerchant) messageFind.condition("merchantId", merchantId)
                messageFind.disableAuthz()
                def messageList = messageFind.list()

                Closure<String> truncate = { String text, int length ->
                    if (!text) return ""
                    String cleaned = text.replaceAll("\\s+", " ").trim()
                    return cleaned.length() > length ? cleaned.substring(0, length) + "…" : cleaned
                }

                for (sess in sessionList) {
                    def lastMessage = messageList.find { it.sessionId == sess.sessionId }
                    telegramSessionsDisplay.add([
                        sessionId     : sess.sessionId,
                        merchantName  : getPartyName(sess.merchantId),
                        customerName  : getPartyName(sess.customerId),
                        status        : sess.status ?: "ACTIVE",
                        currentPhase  : sess.currentPhase ?: "待分配",
                        updatedDate   : sess.lastModifiedDate ?: sess.createdDate,
                        lastMessage   : lastMessage ? truncate(lastMessage.content ?: lastMessage.message, 80) : '—',
                        lastIntent    : lastMessage?.intent ?: '—'
                    ])
                }

                for (msg in messageList) {
                    recentTelegramMessagesDisplay.add([
                        sessionId   : msg.sessionId,
                        merchantName: getPartyName(msg.merchantId),
                        content     : (truncate(msg.content ?: msg.message, 100) ?: '—'),
                        aiResponse  : (truncate(msg.aiResponse, 100) ?: '—'),
                        intent      : msg.intent,
                        processedDate: msg.processedDate
                    ])
                }
            } catch (Exception e) {
                ec.logger.warn("Telegram 会话数据加载失败: ${e.message}")
            }
        ]]></script>
    </actions>
    <widgets>
        <!-- 页面头部 - 使用Quasar 2风格 -->
        <container style="margin-bottom: 16px; border: 1px solid #e0e0e0; border-radius: 4px; padding: 16px;">
            <container style="font-size: 2rem; font-weight: bold; color: #1976d2; margin-bottom: 8px;">
                <label text="智能供需平台控制台"/>
            </container>
            <container style="color: #616161; margin-top: 8px; display: flex; gap: 8px;">
                <label style="background: #1976d2; color: white; padding: 4px 8px; border-radius: 4px; display: inline-block;"
                       text="当前视角：${displayMerchantName}"/>
                <label style="background: #4caf50; color: white; padding: 4px 8px; border-radius: 4px; display: inline-block;"
                       text="Telegram Bot：${botUsername}"/>
            </container>
        </container>

        <!-- 筛选表单 -->
        <container style="margin-bottom: 16px; border: 1px solid #e0e0e0; border-radius: 4px; padding: 16px;">
            <container style="font-size: 1.25rem; font-weight: 500; margin-bottom: 8px;">
                <label text="筛选条件"/>
            </container>
            <form-single name="FilterForm" method="get">
                <container-row>
                    <row-col lg="8" md="8" sm="12">
                        <field name="merchantId">
                            <default-field title="商户ID">
                                <text-line size="30" default-value="${filterMerchant}"/>
                            </default-field>
                        </field>
                    </row-col>
                    <row-col lg="4" md="4" sm="12">
                        <field name="submit">
                            <default-field title="">
                                <submit text="应用筛选"/>
                            </default-field>
                        </field>
                    </row-col>
                </container-row>
            </form-single>
        </container>

        <!-- 统计数据区域 -->
        <container style="font-size: 1.5rem; font-weight: 500; margin-bottom: 16px;">
            <label text="数据统计"/>
        </container>
        <container-row>
            <row-col lg="3" md="6" sm="12">
                <container style="text-align: center; margin-bottom: 16px; border: 1px solid #e0e0e0; border-radius: 4px; padding: 16px;">
                    <label style="font-size: 1.25rem; color: #1976d2;" text="活跃供应"/>
                    <label style="font-size: 2rem; font-weight: bold; color: #1976d2; margin: 8px 0;"
                           text="${stats.activeSupplyListings ?: 0}"/>
                    <label style="font-size: 0.875rem; color: #616161;"
                           text="总计：${stats.totalSupplyListings ?: 0}"/>
                </container>
            </row-col>
            <row-col lg="3" md="6" sm="12">
                <container style="text-align: center; margin-bottom: 16px; border: 1px solid #e0e0e0; border-radius: 4px; padding: 16px;">
                    <label style="font-size: 1.25rem; color: #4caf50;" text="活跃需求"/>
                    <label style="font-size: 2rem; font-weight: bold; color: #4caf50; margin: 8px 0;"
                           text="${stats.activeDemandListings ?: 0}"/>
                    <label style="font-size: 0.875rem; color: #616161;"
                           text="总计：${stats.totalDemandListings ?: 0}"/>
                </container>
            </row-col>
            <row-col lg="3" md="6" sm="12">
                <container style="text-align: center; margin-bottom: 16px; border: 1px solid #e0e0e0; border-radius: 4px; padding: 16px;">
                    <label style="font-size: 1.25rem; color: #2196f3;" text="匹配总数"/>
                    <label style="font-size: 2rem; font-weight: bold; color: #2196f3; margin: 8px 0;"
                           text="${stats.totalMatches ?: 0}"/>
                    <label style="font-size: 0.875rem; color: #616161;"
                           text="平均匹配度：${matchingStats?.averageScore != null ? ec.l10n.format(matchingStats.averageScore * 100, '##0.0') + '%' : '—'}"/>
                </container>
            </row-col>
            <row-col lg="3" md="6" sm="12">
                <container style="text-align: center; margin-bottom: 16px; border: 1px solid #e0e0e0; border-radius: 4px; padding: 16px;">
                    <label style="font-size: 1.25rem; color: #ff9800;" text="Telegram 会话"/>
                    <label style="font-size: 2rem; font-weight: bold; color: #ff9800; margin: 8px 0;"
                           text="${telegramStats.totalSessions ?: 0}"/>
                    <label style="font-size: 0.875rem; color: #616161;"
                           text="今日新增：${telegramStats.todaySessions ?: 0}"/>
                </container>
            </row-col>
        </container-row>

        <!-- 次要统计数据 -->
        <container-row>
            <row-col lg="3" md="6" sm="12">
                <container style="text-align: center; margin-bottom: 16px; border: 1px solid #e0e0e0; border-radius: 4px; padding: 16px;">
                    <label style="font-size: 1rem;" text="活跃会话"/>
                    <label style="font-size: 1.5rem; font-weight: bold; margin: 8px 0;"
                           text="${telegramStats.activeSessions ?: 0}"/>
                </container>
            </row-col>
            <row-col lg="3" md="6" sm="12">
                <container style="text-align: center; margin-bottom: 16px; border: 1px solid #e0e0e0; border-radius: 4px; padding: 16px;">
                    <label style="font-size: 1rem;" text="最近匹配得分"/>
                    <label style="font-size: 1.5rem; font-weight: bold; margin: 8px 0;"
                           text="${recentMatchesDisplay ? recentMatchesDisplay[0].matchScorePercent + '%' : '—'}"/>
                </container>
            </row-col>
            <row-col lg="3" md="6" sm="12">
                <container style="text-align: center; margin-bottom: 16px; border: 1px solid #e0e0e0; border-radius: 4px; padding: 16px;">
                    <label style="font-size: 1rem;" text="最近供应"/>
                    <label style="font-size: 1.5rem; font-weight: bold; margin: 8px 0;"
                           text="${recentSupplies ? recentSupplies.size() : 0}"/>
                </container>
            </row-col>
            <row-col lg="3" md="6" sm="12">
                <container style="text-align: center; margin-bottom: 16px; border: 1px solid #e0e0e0; border-radius: 4px; padding: 16px;">
                    <label style="font-size: 1rem;" text="最近需求"/>
                    <label style="font-size: 1.5rem; font-weight: bold; margin: 8px 0;"
                           text="${recentDemands ? recentDemands.size() : 0}"/>
                </container>
            </row-col>
        </container-row>

        <container>
            <label text="Telegram 会话列表" type="h4"/>
            <container style="table table-striped">
                <container style="thead">
                    <container style="tr">
                        <container style="th"><label text="会话ID"/></container>
                        <container style="th"><label text="客户/商户"/></container>
                        <container style="th"><label text="状态"/></container>
                        <container style="th"><label text="阶段"/></container>
                        <container style="th"><label text="最后意图"/></container>
                        <container style="th"><label text="最近消息"/></container>
                        <container style="th"><label text="更新时间"/></container>
                    </container>
                </container>
                <container style="tbody">
                    <section-iterate name="TelegramSessionsIterate" list="telegramSessionsDisplay" entry="session">
                        <widgets>
                            <container style="tr">
                                <container style="td"><label text="${session.sessionId ?: '—'}"/></container>
                                <container style="td"><label text="${session.customerName ?: '—'}"/></container>
                                <container style="td"><label text="${session.status ?: '—'}"/></container>
                                <container style="td"><label text="${session.currentPhase ?: '—'}"/></container>
                                <container style="td"><label text="${session.lastIntent ?: '—'}"/></container>
                                <container style="td"><label text="${session.lastMessage ?: '—'}"/></container>
                                <container style="td"><label text="${session.updatedDate ? ec.l10n.format(session.updatedDate, 'yyyy-MM-dd HH:mm') : '—'}"/></container>
                            </container>
                        </widgets>
                    </section-iterate>
                </container>
            </container>
        </container>

        <container>
            <label text="最新 Telegram 消息" type="h4"/>
            <container style="table table-striped">
                <container style="thead">
                    <container style="tr">
                        <container style="th"><label text="会话ID"/></container>
                        <container style="th"><label text="商户"/></container>
                        <container style="th"><label text="用户消息"/></container>
                        <container style="th"><label text="AI 回复"/></container>
                        <container style="th"><label text="意图"/></container>
                        <container style="th"><label text="时间"/></container>
                    </container>
                </container>
                <container style="tbody">
                    <section-iterate name="TelegramMessagesIterate" list="recentTelegramMessagesDisplay" entry="message">
                        <widgets>
                            <container style="tr">
                                <container style="td"><label text="${message.sessionId ?: '—'}"/></container>
                                <container style="td"><label text="${message.merchantName ?: '—'}"/></container>
                                <container style="td"><label text="${message.content ?: '—'}"/></container>
                                <container style="td"><label text="${message.aiResponse ?: '—'}"/></container>
                                <container style="td"><label text="${message.intent ?: '—'}"/></container>
                                <container style="td"><label text="${message.processedDate ? ec.l10n.format(message.processedDate, 'MM-dd HH:mm') : '—'}"/></container>
                            </container>
                        </widgets>
                    </section-iterate>
                </container>
            </container>
        </container>

        <container>
            <label text="最近供应" type="h4"/>
            <container style="table table-striped">
                <container style="thead">
                    <container style="tr">
                        <container style="th"><label text="标题"/></container>
                        <container style="th"><label text="数量"/></container>
                        <container style="th"><label text="价格下限"/></container>
                        <container style="th"><label text="价格上限"/></container>
                        <container style="th"><label text="状态"/></container>
                    </container>
                </container>
                <container style="tbody">
                    <section-iterate name="RecentSupplyIterate" list="recentSupplies" entry="supply">
                        <widgets>
                            <container style="tr">
                                <container style="td"><label text="${supply.title ?: '—'}"/></container>
                                <container style="td"><label text="${supply.quantity ?: '—'}"/></container>
                                <container style="td"><label text="${supply.priceMin ? ec.l10n.format(supply.priceMin, '###,##0.00') : '—'}"/></container>
                                <container style="td"><label text="${supply.priceMax ? ec.l10n.format(supply.priceMax, '###,##0.00') : '—'}"/></container>
                                <container style="td"><label text="${supply.status ?: '—'}"/></container>
                            </container>
                        </widgets>
                    </section-iterate>
                </container>
            </container>
        </container>

        <container>
            <label text="最近需求" type="h4"/>
            <container style="table table-striped">
                <container style="thead">
                    <container style="tr">
                        <container style="th"><label text="标题"/></container>
                        <container style="th"><label text="需求量"/></container>
                        <container style="th"><label text="预算"/></container>
                        <container style="th"><label text="状态"/></container>
                    </container>
                </container>
                <container style="tbody">
                    <section-iterate name="RecentDemandIterate" list="recentDemands" entry="demand">
                        <widgets>
                            <container style="tr">
                                <container style="td"><label text="${demand.title ?: '—'}"/></container>
                                <container style="td"><label text="${demand.quantity ?: '—'}"/></container>
                                <container style="td"><label text="${demand.priceMax ? ec.l10n.format(demand.priceMax, '###,##0.00') : '—'}"/></container>
                                <container style="td"><label text="${demand.status ?: '—'}"/></container>
                            </container>
                        </widgets>
                    </section-iterate>
                </container>
            </container>
        </container>

        <container>
            <label text="最新撮合结果" type="h4"/>
            <container style="table table-striped">
                <container style="thead">
                    <container style="tr">
                        <container style="th"><label text="供应"/></container>
                        <container style="th"><label text="需求"/></container>
                        <container style="th"><label text="匹配度(%)"/></container>
                        <container style="th"><label text="状态"/></container>
                        <container style="th"><label text="时间"/></container>
                    </container>
                </container>
                <container style="tbody">
                    <section-iterate name="RecentMatchIterate" list="recentMatchesDisplay" entry="match">
                        <widgets>
                            <container style="tr">
                                <container style="td"><label text="${match.supplyTitle ?: '—'}"/></container>
                                <container style="td"><label text="${match.demandTitle ?: '—'}"/></container>
                                <container style="td"><label text="${match.matchScorePercent ?: '—'}"/></container>
                                <container style="td"><label text="${match.status ?: '—'}"/></container>
                                <container style="td"><label text="${match.suggestedDate ? ec.l10n.format(match.suggestedDate, 'MM-dd HH:mm') : '—'}"/></container>
                            </container>
                        </widgets>
                    </section-iterate>
                </container>
            </container>
        </container>

        <container>
            <label text="快速操作" type="h4"/>
            <link url="../Supply/CreateSupply" text="发布新供应" btn-type="primary"/>
            <link url="../Demand/CreateDemand" text="发布新需求" btn-type="info"/>
            <link url="../Matching" text="查看撮合结果" btn-type="success"/>
            <link url="../Chat" text="打开 AI 助手" btn-type="warning"/>
        </container>
    </widgets>
</screen>
