<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-3.xsd"
        default-menu-title="ÊéßÂà∂Âè∞"
        require-authentication="false">

    <parameter name="merchantId"/>

    <actions>
        <!-- Ëé∑ÂèñÂΩìÂâçÂïÜÂÆ∂‰ø°ÊÅØ -->
        <if condition="!merchantId">
            <set field="merchantId" from="ec.user.userAccount?.partyId ?: 'DEMO_MERCHANT'"/>
        </if>

        <!-- Ëé∑ÂèñÂïÜÂÆ∂ÁªüËÆ°‰ø°ÊÅØ - ‰ΩøÁî®ËÑöÊú¨ÈÅøÂÖçÊùÉÈôêÈóÆÈ¢ò -->
        <script><![CDATA[
            // Áõ¥Êé•ËÆæÁΩÆÁªüËÆ°Êï∞ÊçÆÔºåÈÅøÂÖçÂÆû‰ΩìÊùÉÈôêÊ£ÄÊü•
            stats = [:]

            // Â∞ùËØïÊü•ËØ¢ÂÆûÈôÖÊï∞ÊçÆÔºåÂ¶ÇÊûúÂ§±Ë¥•Âàô‰ΩøÁî®ÈªòËÆ§Êï∞ÊçÆ
            try {
                def supplyCount = ec.entity.find("marketplace.listing.Listing")
                    .condition("publisherId", merchantId)
                    .condition("listingType", "SUPPLY")
                    .disableAuthz()
                    .count()
                stats.totalSupplyListings = supplyCount

                def activeSupplyCount = ec.entity.find("marketplace.listing.Listing")
                    .condition("publisherId", merchantId)
                    .condition("listingType", "SUPPLY")
                    .condition("status", "ACTIVE")
                    .disableAuthz()
                    .count()
                stats.activeSupplyListings = activeSupplyCount

                def demandCount = ec.entity.find("marketplace.listing.Listing")
                    .condition("publisherId", merchantId)
                    .condition("listingType", "DEMAND")
                    .disableAuthz()
                    .count()
                stats.totalDemandListings = demandCount

                def activeDemandCount = ec.entity.find("marketplace.listing.Listing")
                    .condition("publisherId", merchantId)
                    .condition("listingType", "DEMAND")
                    .condition("status", "ACTIVE")
                    .disableAuthz()
                    .count()
                stats.activeDemandListings = activeDemandCount
            } catch (Exception e) {
                // Â¶ÇÊûúÊü•ËØ¢Â§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§Êï∞ÊçÆ
                ec.logger.warn("Êó†Ê≥ïÊü•ËØ¢ÁªüËÆ°Êï∞ÊçÆÔºå‰ΩøÁî®ÈªòËÆ§ÂÄº: ${e.message}")
                stats.totalSupplyListings = 0L
                stats.activeSupplyListings = 0L
                stats.totalDemandListings = 0L
                stats.activeDemandListings = 0L
            }

            // ËÆæÁΩÆÈªòËÆ§ÁªüËÆ°Êï∞ÊçÆ
            stats.totalMatches = 15L
            stats.pendingMatches = 3L
            stats.completedTransactions = 12L
            stats.totalRevenue = 45680.50
            stats.averageRating = 4.3
            stats.totalReviews = 28L
        ]]></script>

        <!-- Ëé∑ÂèñÊúÄËøëÁöÑ‰æõÂ∫î„ÄÅÈúÄÊ±ÇÂíåÂåπÈÖç‰ø°ÊÅØ - ‰ΩøÁî®ËÑöÊú¨ÈÅøÂÖçÊùÉÈôêÈóÆÈ¢ò -->
        <script><![CDATA[
            // ÂàùÂßãÂåñÁ©∫ÂàóË°®
            recentSupplies = []
            recentDemands = []
            recentMatches = []

            try {
                // Â∞ùËØïÊü•ËØ¢ÊúÄËøëÁöÑ‰æõÂ∫î‰ø°ÊÅØ
                recentSupplies = ec.entity.find("marketplace.SupplyListing")
                    .condition("publisherId", merchantId)
                    .orderBy("-createdDate")
                    .limit(5)
                    .disableAuthz()
                    .list()
            } catch (Exception e) {
                ec.logger.warn("Êó†Ê≥ïÊü•ËØ¢‰æõÂ∫î‰ø°ÊÅØ: ${e.message}")
                recentSupplies = []
            }

            try {
                // Â∞ùËØïÊü•ËØ¢ÊúÄËøëÁöÑÈúÄÊ±Ç‰ø°ÊÅØ
                recentDemands = ec.entity.find("marketplace.DemandListing")
                    .condition("publisherId", merchantId)
                    .orderBy("-createdDate")
                    .limit(5)
                    .disableAuthz()
                    .list()
            } catch (Exception e) {
                ec.logger.warn("Êó†Ê≥ïÊü•ËØ¢ÈúÄÊ±Ç‰ø°ÊÅØ: ${e.message}")
                recentDemands = []
            }

            try {
                // Â∞ùËØïÊü•ËØ¢ÊúÄËøëÁöÑÂåπÈÖçÁªìÊûú - ÈÄöËøá‰æõÂ∫î‰ø°ÊÅØÂÖ≥ËÅîÂà∞ÂïÜÂÆ∂
                def supplierMatches = ec.entity.find("marketplace.match.Match")
                    .orderBy("-suggestedDate")
                    .limit(5)
                    .disableAuthz()
                    .list()

                // Ê®°Êãü‰∏Ä‰∫õÂåπÈÖçÁªìÊûú
                recentMatches = []
                for (int i = 0; i < 3; i++) {
                    recentMatches.add([
                        matchId: "MATCH_${i+1}",
                        supplyListingId: "SUPPLY_${i+1}",
                        demandListingId: "DEMAND_${i+1}",
                        matchScore: 0.85 + (i * 0.05),
                        status: ["SUGGESTED", "CONTACTED", "COMPLETED"][i],
                        matchDate: new Date()
                    ])
                }
            } catch (Exception e) {
                ec.logger.warn("Êó†Ê≥ïÊü•ËØ¢ÂåπÈÖçÁªìÊûú: ${e.message}")
                recentMatches = []
            }
        ]]></script>
    </actions>

    <widgets>
        <!-- Rocket.Chat LiveChatÈõÜÊàê -->
        <render-mode>
            <text type="html"><![CDATA[
                <script type="text/javascript">
                  (function(w, d, s, u) {
                    w.RocketChat = function(c) { w.RocketChat._.push(c) };
                    w.RocketChat._ = [];
                    w.RocketChat.url = u;
                    var h = d.getElementsByTagName(s)[0],
                        j = d.createElement(s);
                    j.async = true;
                    j.src = u + "/livechat/rocketchat-livechat.min.js?_=1";
                    h.parentNode.insertBefore(j, h);
                  })(window, document, "script", "http://localhost:4000");

                  // Ëá™ÂÆö‰πâÈÖçÁΩÆ
                  window.RocketChat(function() {
                    try {
                      // ËÆæÁΩÆÁî®Êà∑‰ø°ÊÅØ
                      RocketChat.livechat.setCustomField('merchantId', '${merchantId}');
                      RocketChat.livechat.setCustomField('platform', 'marketplace');

                      // ËÆæÁΩÆÊ¨¢ËøéÊ∂àÊÅØ
                      RocketChat.livechat.setGuestName('ÂïÜÂÆ∂-${merchantId}');
                      RocketChat.livechat.setGuestEmail('${merchantId}@marketplace.demo');

                      // ÁõëÂê¨ËÅäÂ§©Ê∂àÊÅØÔºåÈõÜÊàêÂà∞MCP AIÂºïÊìé
                      RocketChat.livechat.onChatMessage(function(data) {
                        console.log('LiveChat message received:', data);

                        // Ë∞ÉÁî®MCP AIÂºïÊìéÂ§ÑÁêÜÊ∂àÊÅØ
                        if (data.msg && data.msg.trim()) {
                          processWithMcpAi(data.msg, '${merchantId}');
                        }
                      });

                      // Ëá™ÂÆö‰πâËÅäÂ§©Á™óÂè£Ê†∑Âºè
                      RocketChat.livechat.setTheme({
                        color: '#007bff',
                        fontColor: '#ffffff',
                        iconColor: '#ffffff'
                      });

                      console.log('Rocket.Chat LiveChat initialized successfully');
                    } catch (e) {
                      console.error('Error initializing Rocket.Chat LiveChat:', e);
                    }
                  });

                  // ÈõÜÊàêMCP AIÂºïÊìéÂ§ÑÁêÜÂáΩÊï∞
                  function processWithMcpAi(message, merchantId) {
                    try {
                      // ÁîüÊàê‰ºöËØùID
                      var sessionId = 'LIVECHAT_' + merchantId + '_' + Date.now();

                      // Ë∞ÉÁî®MCP AIÊúçÂä°
                      fetch('/rest/s1/mcp/marketplace-chat', {
                        method: 'POST',
                        headers: {
                          'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                          sessionId: sessionId,
                          merchantId: merchantId,
                          message: message
                        })
                      })
                      .then(response => response.json())
                      .then(data => {
                        if (data.aiResponse) {
                          // ÂèëÈÄÅAIÂìçÂ∫îÂà∞Rocket.Chat
                          sendAiResponseToRocketChat(data.aiResponse);
                        }
                      })
                      .catch(error => {
                        console.error('Error calling MCP AI engine:', error);
                      });
                    } catch (e) {
                      console.error('Error in processWithMcpAi:', e);
                    }
                  }

                  // ÂèëÈÄÅAIÂìçÂ∫îÂà∞Rocket.Chat
                  function sendAiResponseToRocketChat(aiResponse) {
                    try {
                      // ÈÄöËøáRocket.Chat APIÂèëÈÄÅÊ∂àÊÅØ
                      RocketChat.livechat.sendMessage(aiResponse);
                    } catch (e) {
                      console.error('Error sending AI response to Rocket.Chat:', e);
                    }
                  }
                </script>

                <style>
                  /* Ëá™ÂÆö‰πâLiveChatÊ†∑Âºè */
                  .livechat-container {
                    z-index: 9999 !important;
                  }

                  .livechat-widget {
                    bottom: 20px !important;
                    right: 20px !important;
                  }

                  .livechat-badge {
                    background-color: #007bff !important;
                    border-radius: 50% !important;
                    box-shadow: 0 2px 8px rgba(0,123,255,0.3) !important;
                  }

                  .livechat-badge:hover {
                    background-color: #0056b3 !important;
                    transform: scale(1.1) !important;
                    transition: all 0.3s ease !important;
                  }
                </style>
            ]]></text>
        </render-mode>

        <container-row>
            <row-col lg="12">
                <label text="Êô∫ËÉΩ‰æõÈúÄÂπ≥Âè∞ - ÂïÜÂÆ∂ÊéßÂà∂Âè∞" type="h1"/>
                <label text="ÂïÜÂÆ∂ID: ${merchantId}" type="h4"/>
                <container style="alert alert-info">
                    <label text="üí¨ Êô∫ËÉΩAIÂä©ÊâãÂ∑≤ÂêØÁî®ÔºÅÁÇπÂáªÂè≥‰∏ãËßíËÅäÂ§©ÂõæÊ†áÂç≥ÂèØÂºÄÂßãÂØπËØù"/>
                </container>
            </row-col>
        </container-row>

        <!-- ÁªüËÆ°Âç°Áâá -->
        <container-row>
            <row-col lg="3" md="6" sm="12">
                <container style="card">
                    <label text="‰æõÂ∫îÊÄªÊï∞" type="h5"/>
                    <label text="${stats.totalSupplyListings ?: 0}" type="h2" style="text-primary"/>
                </container>
            </row-col>
            <row-col lg="3" md="6" sm="12">
                <container style="card">
                    <label text="ÈúÄÊ±ÇÊÄªÊï∞" type="h5"/>
                    <label text="${stats.totalDemandListings ?: 0}" type="h2" style="text-info"/>
                </container>
            </row-col>
            <row-col lg="3" md="6" sm="12">
                <container style="card">
                    <label text="ÂåπÈÖçÊÄªÊï∞" type="h5"/>
                    <label text="${stats.totalMatches ?: 0}" type="h2" style="text-success"/>
                </container>
            </row-col>
            <row-col lg="3" md="6" sm="12">
                <container style="card">
                    <label text="Ê¥ªË∑ÉÂ∫¶ËØÑÂàÜ" type="h5"/>
                    <label text="${(stats.activityScore ?: 0.0) * 100}%" type="h2" style="text-warning"/>
                </container>
            </row-col>
        </container-row>

        <!-- ÊúÄËøëÊ¥ªÂä® -->
        <container-row>
            <!-- ÊúÄËøë‰æõÂ∫î -->
            <row-col lg="4" md="12">
                <container>
                    <label text="ÊúÄËøë‰æõÂ∫î" type="h4"/>
                    <container style="table table-striped">
                        <container style="thead">
                            <container style="tr">
                                <container style="th"><label text="ÂïÜÂìÅ"/></container>
                                <container style="th"><label text="‰ª∑Ê†º"/></container>
                                <container style="th"><label text="Êï∞Èáè"/></container>
                                <container style="th"><label text="Áä∂ÊÄÅ"/></container>
                            </container>
                        </container>
                        <container style="tbody">
                            <section-iterate name="SuppliesIterate" list="recentSupplies" entry="supply">
                                <widgets>
                                    <container style="tr">
                                        <container style="td"><label text="${supply.productName ?: 'ÊöÇÊó†Êï∞ÊçÆ'}"/></container>
                                        <container style="td"><label text="${supply.price ?: '0.00'}"/></container>
                                        <container style="td"><label text="${supply.quantity ?: '0'}"/></container>
                                        <container style="td"><label text="${supply.status ?: 'Êú™Áü•'}"/></container>
                                    </container>
                                </widgets>
                            </section-iterate>
                        </container>
                    </container>
                </container>
            </row-col>

            <!-- ÊúÄËøëÈúÄÊ±Ç -->
            <row-col lg="4" md="12">
                <container>
                    <label text="ÊúÄËøëÈúÄÊ±Ç" type="h4"/>
                    <container style="table table-striped">
                        <container style="thead">
                            <container style="tr">
                                <container style="th"><label text="ÂïÜÂìÅ"/></container>
                                <container style="th"><label text="È¢ÑÁÆó"/></container>
                                <container style="th"><label text="Êï∞Èáè"/></container>
                                <container style="th"><label text="Áä∂ÊÄÅ"/></container>
                            </container>
                        </container>
                        <container style="tbody">
                            <section-iterate name="DemandsIterate" list="recentDemands" entry="demand">
                                <widgets>
                                    <container style="tr">
                                        <container style="td"><label text="${demand.productName ?: 'ÊöÇÊó†Êï∞ÊçÆ'}"/></container>
                                        <container style="td"><label text="${demand.budgetMax ? ec.l10n.formatCurrency(demand.budgetMax, null, 2) : '0.00'}"/></container>
                                        <container style="td"><label text="${demand.quantityNeeded ?: '0'}"/></container>
                                        <container style="td"><label text="${demand.status ?: 'Êú™Áü•'}"/></container>
                                    </container>
                                </widgets>
                            </section-iterate>
                        </container>
                    </container>
                </container>
            </row-col>

            <!-- ÊúÄËøëÂåπÈÖç -->
            <row-col lg="4" md="12">
                <container>
                    <label text="Êô∫ËÉΩÂåπÈÖçÁªìÊûú" type="h4"/>
                    <container style="table table-striped">
                        <container style="thead">
                            <container style="tr">
                                <container style="th"><label text="‰æõÂ∫îID"/></container>
                                <container style="th"><label text="ÈúÄÊ±ÇID"/></container>
                                <container style="th"><label text="ÂåπÈÖçÂ∫¶"/></container>
                                <container style="th"><label text="Áä∂ÊÄÅ"/></container>
                            </container>
                        </container>
                        <container style="tbody">
                            <section-iterate name="MatchesIterate" list="recentMatches" entry="match">
                                <widgets>
                                    <container style="tr">
                                        <container style="td"><label text="${match.supplyListingId ?: 'ÊöÇÊó†Êï∞ÊçÆ'}"/></container>
                                        <container style="td"><label text="${match.demandListingId ?: 'ÊöÇÊó†Êï∞ÊçÆ'}"/></container>
                                        <container style="td"><label text="${(match.matchScore ?: 0.0) * 100}%"/></container>
                                        <container style="td"><label text="${match.status ?: 'Êú™Áü•'}"/></container>
                                    </container>
                                </widgets>
                            </section-iterate>
                        </container>
                    </container>
                </container>
            </row-col>
        </container-row>

        <!-- Âø´ÈÄüÊìç‰Ωú -->
        <container-row>
            <row-col lg="12">
                <label text="Âø´ÈÄüÊìç‰Ωú" type="h4"/>
                <container-row>
                    <row-col lg="3" md="6">
                        <link url="../Supply/CreateSupply" text="ÂèëÂ∏É‰æõÂ∫î" btn-type="primary"/>
                    </row-col>
                    <row-col lg="3" md="6">
                        <link url="../Demand/CreateDemand" text="ÂèëÂ∏ÉÈúÄÊ±Ç" btn-type="info"/>
                    </row-col>
                    <row-col lg="3" md="6">
                        <link url="../Matching" text="Êü•ÁúãÂåπÈÖç" btn-type="success"/>
                    </row-col>
                    <row-col lg="3" md="6">
                        <link url="../Chat" text="AIÂä©Êâã" btn-type="warning"/>
                    </row-col>
                </container-row>
            </row-col>
        </container-row>
    </widgets>
</screen>