<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/screen-3.xsd"
        default-menu-index="1">

    <parameter name="filterMerchant"/>

    <transition name="getStatistics" read-only="true">
        <service-call name="marketplace.get#MerchantStatistics" in-map="context" out-map="context"/>
        <default-response type="none"/>
    </transition>

    <actions>
        <service-call name="marketplace.get#MerchantStatistics" in-map="[merchantId: filterMerchant]" out-map="context"/>

        <script><![CDATA[
            // å•†æˆ·ä¿¡æ¯
            if (filterMerchant) {
                def merchant = ec.entity.find("mantle.party.Party")
                    .condition("partyId", filterMerchant)
                    .condition("partyTypeEnumId", "PtyOrganization")
                    .disableAuthz()
                    .one()
                displayMerchantName = merchant?.organizationName ?: filterMerchant
            } else {
                displayMerchantName = "å…¨éƒ¨å•†æˆ·è§†è§’"
            }

            // Telegram Boté…ç½®
            try {
                botUsername = ec.factory.getToolFactory("SystemPropertyValue")?.getPropertyValue("mcp.telegram.bot.username") ?: "MarketplaceMCPBot"
            } catch (Exception e) {
                botUsername = "MarketplaceMCPBot"
            }
        ]]></script>
    </actions>

    <widgets>
        <!-- é¡µé¢æ ‡é¢˜åŒºåŸŸ -->
        <container style="q-pa-md">
            <container style="q-mb-md">
                <label text="ðŸ¤ ä¾›éœ€åŒ¹é…æŽ§åˆ¶å°" type="h4"/>
                <label text="æ™ºèƒ½AIé©±åŠ¨çš„B2Bä¾›éœ€æ’®åˆå¹³å°" style="color: #666; font-size: 14px;"/>
            </container>

            <!-- å½“å‰è§†è§’å’Œç­›é€‰ -->
            <container style="q-card q-pa-md q-mb-md bg-grey-1">
                <container style="row q-gutter-md items-center">
                    <container style="col-auto">
                        <label text="å½“å‰è§†è§’ï¼š${displayMerchantName}" style="font-weight: 500;"/>
                    </container>
                    <container style="col-auto">
                        <label text="Bot: ${botUsername}" style="color: #666; font-size: 12px;"/>
                    </container>
                    <container style="col">
                        <form-single name="FilterForm" method="get">
                            <field name="merchantId">
                                <default-field title="å•†æˆ·ç­›é€‰">
                                    <text-line size="20" default-value="${filterMerchant}" placeholder="è¾“å…¥å•†æˆ·ID"/>
                                </default-field>
                            </field>
                            <field name="submit">
                                <default-field title="">
                                    <submit text="ç­›é€‰"/>
                                </default-field>
                            </field>
                        </form-single>
                    </container>
                </container>
            </container>

            <!-- å…³é”®ç»Ÿè®¡å¡ç‰‡ -->
            <container style="q-mb-md">
                <label text="ðŸ“Š å…³é”®ç»Ÿè®¡" type="h5" style="q-mb-sm"/>
                <container style="row q-gutter-md">
                    <container style="col q-card q-pa-md">
                        <container style="text-center">
                            <label text="ä¾›åº”ä¿¡æ¯" style="font-size: 14px; color: #666;"/>
                            <container style="q-mt-sm">
                                <label text="${totalSupplyListings ?: 0}" style="font-size: 24px; font-weight: bold; color: #1976d2;"/>
                                <label text="æ€»æ•°" style="font-size: 12px; color: #666; margin-left: 8px;"/>
                            </container>
                            <container style="q-mt-xs">
                                <label text="${activeSupplyListings ?: 0}" style="font-size: 16px; color: #4caf50;"/>
                                <label text="æ´»è·ƒ" style="font-size: 12px; color: #666; margin-left: 4px;"/>
                            </container>
                        </container>
                    </container>

                    <container style="col q-card q-pa-md">
                        <container style="text-center">
                            <label text="éœ€æ±‚ä¿¡æ¯" style="font-size: 14px; color: #666;"/>
                            <container style="q-mt-sm">
                                <label text="${totalDemandListings ?: 0}" style="font-size: 24px; font-weight: bold; color: #ff9800;"/>
                                <label text="æ€»æ•°" style="font-size: 12px; color: #666; margin-left: 8px;"/>
                            </container>
                            <container style="q-mt-xs">
                                <label text="${activeDemandListings ?: 0}" style="font-size: 16px; color: #4caf50;"/>
                                <label text="æ´»è·ƒ" style="font-size: 12px; color: #666; margin-left: 4px;"/>
                            </container>
                        </container>
                    </container>

                    <container style="col q-card q-pa-md">
                        <container style="text-center">
                            <label text="æ™ºèƒ½åŒ¹é…" style="font-size: 14px; color: #666;"/>
                            <container style="q-mt-sm">
                                <label text="${totalMatches ?: 0}" style="font-size: 24px; font-weight: bold; color: #9c27b0;"/>
                                <label text="æ€»æ•°" style="font-size: 12px; color: #666; margin-left: 8px;"/>
                            </container>
                            <container style="q-mt-xs">
                                <label text="${pendingMatches ?: 0}" style="font-size: 16px; color: #ff5722;"/>
                                <label text="å¾…å¤„ç†" style="font-size: 12px; color: #666; margin-left: 4px;"/>
                            </container>
                        </container>
                    </container>
                </container>
            </container>

            <!-- å¿«é€Ÿæ“ä½œåŒºåŸŸ -->
            <container style="q-card q-pa-md">
                <label text="ðŸš€ å¿«é€Ÿæ“ä½œ" type="h5" style="q-mb-md"/>
                <container style="row q-gutter-md">
                    <link url="Supply" text="ðŸ“¦ ç®¡ç†ä¾›åº”" btn-type="primary" style="col"/>
                    <link url="Demand" text="ðŸ›’ ç®¡ç†éœ€æ±‚" btn-type="secondary" style="col"/>
                    <link url="Matching" text="ðŸ¤– æ™ºèƒ½åŒ¹é…" btn-type="accent" style="col"/>
                </container>
            </container>
        </container>
    </widgets>
</screen>